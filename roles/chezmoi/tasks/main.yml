---

- name: Install chezmoi (deb)
  become: true
  apt:
    deb: "https://github.com/twpayne/chezmoi/releases/download/v{{ chezmoi_version }}/chezmoi_{{ chezmoi_version }}_linux_amd64.deb"
    state: present
  when: ansible_os_family == 'Debian'
  tags: "install"

- name: Install chezmoi
  become: true
  package:
    name: chezmoi
    state: present
  when: ansible_os_family != 'Debian'
  tags: "install"

- name: Ensure overrides dir exists
  file:
    path: "{{ chezmoi_user_override }}"
    state: directory
    owner: "{{ chezmoi_user }}"
    group: "{{ chezmoi_user }}"
    mode: 0644
  when: chezmoi_overrides | length > 0

- name: Copy overrides
  copy:
    content: "{{ item.value }}"
    dest: "{{ chezmoi_user_override }}/{{ item.key }}"
    owner: "{{ chezmoi_user }}"
    group: "{{ chezmoi_user }}"
    mode: 0644
    force: "{{ chezmoi_overwrite }}"
  with_dict: "{{ chezmoi_overrides }}"
  loop_control:
    label: "{{ item.key }}"
