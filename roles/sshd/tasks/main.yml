---

- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

- name: Install OpenSSH server
  become: true
  package:
    name: "{{ _sshd_pkg }}"
    state: present
  tags: ["install"]

- name: Check if sshd_config.d exists
  become: true
  stat:
    path: "/etc/ssh/sshd_config.d"
  register: __ssh_conf_d

- name: Configure using sshd_config.d
  become: true
  copy:
    content: "{{ sshd_config | map(attribute='line') | join('\n') }}\n"
    dest: /etc/ssh/sshd_config.d/00-ansible.conf
    owner: root
    group: root
    mode: 0600
  notify: reload sshd
  when: __ssh_conf_d.stat.exists

- name: Set up sshd_config
  become: true
  lineinfile:
    dest: "/etc/ssh/sshd_config"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  with_items: "{{ sshd_config }} "
  when: not __ssh_conf_d.stat.exists
  notify: reload sshd

- name: Set up extra sshd config
  become: true
  blockinfile:
    path: "/etc/ssh/sshd_config"
    block: "{{ sshd_extra_config }}"
  when: sshd_extra_config | length > 0
  notify: reload sshd
