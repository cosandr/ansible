---

- block:
    - name: Clone repository
      git:
        repo: https://github.com/nshttpd/mikrotik-exporter.git
        version: "{{ mikrotik_exporter_version }}"
        dest: "/tmp/mikrotik-exporter-{{ mikrotik_exporter_version }}"
        force: true

    - name: Get build dependencies
      command:
        chdir: "/tmp/mikrotik-exporter-{{ mikrotik_exporter_version }}"
        cmd: go mod vendor

    - name: Build exporter
      command:
        chdir: "/tmp/mikrotik-exporter-{{ mikrotik_exporter_version }}"
        cmd: go build -o mikrotik-exporter
      environment:
        CGO_ENABLED: "0"

  diff: false
  delegate_to: localhost
  tags: ["install"]

- name: Copy mikrotik exporter to node
  copy:
    src: "/tmp/mikrotik-exporter-{{ mikrotik_exporter_version }}/mikrotik-exporter"
    dest: /usr/local/bin/mikrotik-exporter
    owner: root
    group: root
    mode: 0755
  notify: restart mikrotik exporter
  tags: ["install"]

- name: Copy config
  copy:
    content: "{{ mikrotik_exporter_config | to_nice_yaml(indent=2) }}"
    dest: "{{ mikrotik_exporter_config_file }}"
    owner: root
    group: root
    mode: 0600
  notify: restart mikrotik exporter
  tags: ["configure"]

- name: Copy systemd service
  template:
    src: "mikrotik-exporter.service.j2"
    dest: /etc/systemd/system/mikrotik-exporter.service
    owner: root
    group: root
    mode: 0644
  notify: restart mikrotik exporter

- name: Enable and start service
  systemd:
    name: mikrotik-exporter.service
    state: started
    enabled: true
