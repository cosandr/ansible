---
- name: Install systemd services
  template:
    src: "{{ item }}"
    dest: "{{ sanoid_unit_dir }}/{{ item | basename | regex_replace('(.*)\\.j2$', '\\1') }}"
    owner: root
    group: root
    mode: 0644
  loop: "{{ lookup('fileglob', 'templates/*.service.j2', wantlist=True) }}"
  notify: Reload systemd

- name: Install systemd timers
  template:
    src: "{{ item }}"
    dest: "{{ sanoid_unit_dir }}/{{ item | basename | regex_replace('(.*)\\.j2$', '\\1') }}"
    owner: root
    group: root
    mode: 0644
  loop: "{{ lookup('fileglob', 'templates/*.timer.j2', wantlist=True) }}"
  notify: Reload systemd

- name: Install config file
  template:
    src: "templates/sanoid.conf.j2"
    dest: "{{ sanoid_config_dir }}/sanoid.conf"
    owner: root
    group: root
    mode: 0644

- name: Enable units
  block:
    - name: "Enable sanoid-prune.service and sanoid.timer"
      service:
        name: "{{ item }}"
        enabled: true
      with_items: ["sanoid-prune.service", "sanoid.timer"]

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: "Start sanoid.timer"
      service:
        name: "sanoid.timer"
        state: "started"

  when: sanoid_enable_units
