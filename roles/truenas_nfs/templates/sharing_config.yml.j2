{% set truenas_sharing_config = dict() %}
{% set _ = truenas_sharing_config.update({'smb': dict()}) %}
{% set _ = truenas_sharing_config.update({'nfs': dict()}) %}
{% for share in truenas_smb['json'] %}
{%   set _ = truenas_sharing_config['smb'].update(
  {
  share['name']: {
    'path': share['path'],
    'id': share['id']
    }
  })
%}
{% endfor %}
{% set create_nfs_shares = [] %}
{% set update_nfs_shares = [] %}
{% set delete_nfs_shares = [] %}
{% set existing_nfs_paths = [] %}
{%     for nfs_share in truenas_nfs['json'] %}
{%       for path in nfs_share['paths'] %}
{%         if path not in existing_nfs_paths %}
{%           set _ = existing_nfs_paths.append(path) %}
{%         endif %}
{%       endfor %}
{%     endfor %}
{% for share in truenas_sharing %}
{%   if share['type']|lower == 'nfs' and share.get('state', 'present') == 'present' %}
{%     set create_nfs_paths = [] %}
{%     set update_nfs_paths = [] %}
{%     for path in share['config']['paths'] %}
{%       if (path not in existing_nfs_paths) or share.get('force_create', false) %}
{%         set _ = create_nfs_paths.append(path) %}
{%       else %}
{%         set _ = update_nfs_paths.append(path) %}
{%       endif %}
{%     endfor %}
{%     if create_nfs_paths != [] %}
{%       set nfs_share_config = share['config'] %}
{%       set _ = create_nfs_shares.append(nfs_share_config) %}
{%     endif %}
{%     if update_nfs_paths != [] %}
{%       set nfs_share_config = {'config': share['config']} %}
{%       for nfs_share in truenas_nfs['json'] %}
{%         for path in nfs_share['paths'] %}
{%           if path in update_nfs_paths %}
{%             set _ = nfs_share_config.update({'id': nfs_share['id']}) %}
{%           endif %}
{%         endfor %}
{%       endfor %}
{%       set _ = update_nfs_shares.append(nfs_share_config) %}
{%     endif %}
{%   elif share['type']|lower == 'nfs' and share['state'] == 'absent' %}
{%     for path in share['config']['paths'] %}
{%       if path in existing_nfs_paths %}
{%         for nfs_share in truenas_nfs['json'] %}
{%           for delete_path in nfs_share['paths'] %}
{%             if delete_path == path %}
{%               if nfs_share['id'] not in delete_nfs_shares %}
{%                 set _ = delete_nfs_shares.append(nfs_share['id']) %}
{%               endif %}
{%             endif %}
{%           endfor %}
{%         endfor %}
{%       endif %}
{%     endfor %}
{%   endif %}
{% endfor %}
{% set _ = truenas_sharing_config['nfs'].update(
  {
  'create_nfs_shares': create_nfs_shares,
  'update_nfs_shares': update_nfs_shares,
  'delete_nfs_shares': delete_nfs_shares
  })
%}
{{ truenas_sharing_config }}
