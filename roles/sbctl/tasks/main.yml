---

- name: Write kernel parameters to {{ sbctl_cmdline }}
  copy:
    dest: "{{ sbctl_cmdline }}"
    owner: root
    group: root
    mode: 0644
    content: "{{ kernel_params }}"

- name: Install sbctl
  pacman:
    name: sbctl
    state: present
  tags: ["install"]

- name: Create keys
  command: "sbctl create-keys"
  args:
    creates: /usr/share/secureboot/GUID

- name: Enroll keys
  command: "sbctl enroll-keys {% if sbctl_enroll_microsoft %}--microsoft{% endif %}"
  args:
    # https://github.com/Foxboron/sbctl/blob/32ac2678342aab8233ee887ea73cc781e907f86a/util.go#L73
    creates: "/sys/firmware/efi/efivars/db-d719b2cb-3d3a-4596-a3bc-dad00e67656f"
  notify: reboot
  when: sbctl_enroll | bool
  tags: ["enroll"]

- name: Ensure {{ esp_mount }}/EFI/Linux exists
  file:
    path: "{{ esp_mount }}/EFI/Linux"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Prepare required facts
  set_fact:
    __bundles: "{{ __bundles | default([]) + [tmp_dict] }}"
  vars:
    tmp_dict:
      label: "{{ item.label | default(ansible_distribution + ' ' + item.kernel) }}"
      kernel_path: "{{ item.kernel_path | default('vmlinuz-' + item.kernel) }}"
      initrd: "{{ item.initrd | default('initramfs-' + item.kernel + '.img') }}"
      bundle: "{{ item.bundle | default(item.kernel + '.efi') }}"
  loop: "{{ sbctl_bundles }}"
  loop_control:
    label: "{{ item.kernel }}"

- name: Bundle kernels
  command: >
    sbctl bundle -s
    -i {{ boot_mount }}/{{ sbctl_ucode }}
    -c {{ sbctl_cmdline }}
    -l {{ efistub_splash }}
    -k {{ boot_mount }}/{{ item.kernel_path }}
    -f {{ boot_mount }}/{{ item.initrd }}
    {{ esp_mount }}/EFI/Linux/{{ item.bundle }}
  args:
    creates: "{{ esp_mount }}/EFI/Linux/{{ item.bundle }}"
  loop: "{{ __bundles }}"

- name: Sign files
  command: "sbctl sign -s {{ item }}"
  register: __sbctl_sign
  changed_when: "'already been signed' not in __sbctl_sign.stdout"
  loop: "{{ sbctl_sign_files }}"

- name: Sign all
  command: "sbctl sign-all -g"
  changed_when: false

- name: Add entries in EFI
  include_role:
    name: "efibootmgr"
  vars:
    disk: "/dev/nvme0n1"
    part: "1"
    loader: "/EFI/Linux/{{ item.bundle }}"
    label: "{{ item.label }}"
  loop: "{{ __bundles }}"
