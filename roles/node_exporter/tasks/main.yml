---
- include_tasks: install.yml
  when:
    - not node_exporter_skip_install
  tags: ["install"]

- include_tasks: configure.yml
  tags: ["configure"]

- name: ensure node_exporter service is started and enabled
  systemd:
    daemon_reload: true
    name: node_exporter
    state: started
    enabled: true

- name: Configure firewall
  include_role:
    name: firewall_config
    apply:
      become: true
      tags: ["firewall"]
  vars:
    firewall_rules:
      - port: "{{ node_exporter_web_listen_address.split(':')[1] }}"
        source: "{{ node_exporter_allow_ip }}"
  when: node_exporter_config_firewall
