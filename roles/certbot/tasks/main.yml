---

- name: Include platform specific vars
  include_vars: "{{ ansible_system }}.yml"

- name: Include install tasks
  include_tasks: install.yml
  when: certbot_install | bool
  tags: ["install"]

- name: Ensure /etc/letsencrypt exists
  file:
    path: "/etc/letsencrypt"
    state: directory
    owner: root
    group: "{{ __root_group }}"
    mode: 0755

- name: Configure certbot
  copy:
    dest: "/etc/letsencrypt/cli.ini"
    owner: root
    group: "{{ __root_group }}"
    mode: 0600
    content: |
      rsa-key-size = 4096
      email = {{ certbot_email }}
      agree-tos = true
  when: certbot_email | length > 0

- name: Add credentials
  copy:
    dest: "{{ certbot_credentials_path }}"
    owner: root
    group: "{{ __root_group }}"
    mode: 0600
    content: "{{ certbot_credentials_content }}"
  when: certbot_credentials_content | length > 0

- name: Get certificates
  command: "{{ certbot_generate_command }} -d '{{ item }}'"
  register: output
  changed_when:
    - output.rc == 0
    - "'Certificate not yet due for renewal; no action taken.' not in output.stdout"
  loop: "{{ certbot_domains }}"
  tags: ["fetch"]
