---

- name: Install EPEL
  ansible.builtin.include_role:
    name: epel
    apply:
      tags: ["install"]
  when:
    - ansible_distribution != 'Fedora'
    - ansible_os_family == 'RedHat'
  tags: ["install"]

- name: Install networkd and resolved
  package:
    name:
      - systemd-networkd
      - systemd-resolved
    state: present
  # They are part of the systemd package on Arch
  when: ansible_distribution != "Archlinux"
  tags: ["install"]

- name: Register previously copied configuration files
  ansible.builtin.find:
    paths: "/etc/systemd/network"
    patterns:
      - "*.network"
      - "*.netdev"
  register: __networkd_present
  when: networkd_provisioning_synced

- name: Copy networkd configs
  copy:
    dest: "/etc/systemd/network/{{ item.key }}.network"
    owner: root
    group: root
    mode: 0644
    content: |
      {{ ansible_managed | comment }}
      {{ item.value }}
  with_dict: "{{ networkd_config }}"
  loop_control:
    label: "{{ item.key }}"
  register: __network_copied
  notify: Restart systemd-networkd

- name: Copy networkd netdevs
  copy:
    dest: "/etc/systemd/network/{{ item.key }}.netdev"
    owner: root
    group: root
    mode: 0644
    content: |
      {{ ansible_managed | comment }}
      {{ item.value }}
  with_dict: "{{ networkd_netdevs }}"
  loop_control:
    label: "{{ item.key }}"
  register: __netdev_copied
  notify: Restart systemd-networkd

- name: Set list facts
  ansible.builtin.set_fact:
    __networkd_present_list: "{{ __networkd_present | json_query('files[*].path') | default([]) }}"
    __networkd_copied_list: "{{ __network_copied_tmp + __network_copied_tmp_check + __netdev_copied_tmp + __netdev_copied_tmp_check }}"
  vars:
    __network_copied_tmp: "{{ __network_copied.results | json_query('[*].dest') | default([]) }}"
    __network_copied_tmp_check: "{{ __network_copied.results | json_query('[*].invocation.dest') | default([]) }}"
    __netdev_copied_tmp: "{{ __netdev_copied.results | json_query('[*].dest') | default([]) }}"
    __netdev_copied_tmp_check: "{{ __netdev_copied.results | json_query('[*].invocation.dest') | default([]) }}"
  when: networkd_provisioning_synced

- name: Remove configs not present on deployer machine (synchronize)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ __networkd_present_list | difference(__networkd_copied_list) }}"
  notify: Restart systemd-networkd
  when: networkd_provisioning_synced

- name: Check if NetworkManager is active  # noqa command-instead-of-module
  command: systemctl is-active -q NetworkManager.service
  check_mode: false
  changed_when: false
  failed_when: false
  register: __nm_active

- name: Disable NM
  when:
    - __nm_active is defined
    - __nm_active.rc is defined
    - __nm_active.rc == 0
  block:
    - name: Stop NetworkManager
      systemd:
        name: NetworkManager
        state: stopped

    - name: Disable NetworkManager
      systemd:
        name: NetworkManager
        enabled: false

- name: Enable and start systemd-networkd/resolved
  systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - "systemd-networkd.service"
    - "systemd-resolved.service"
