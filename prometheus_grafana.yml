---
- name: Prometheus Stack playbook
  gather_facts: true
  diff: yes
  hosts: localhost
  connection: local
  vars_files: .secrets/vars.yml
  vars:
    prometheus_version: latest
    prometheus_skip_install: false
    tls_ca_file: ca.crt
    tls_crt_file: dresrv.crt
    tls_key_file: dresrv.key
    prometheus_port: 9092
    node_port: 9100
    cadvisor_port: 8081
    psqlexporter_port: 9187
    nginxexporter_port: 9113
    desktop_ip: 10.1.0.3
    desktop_label: desktop
    server_label: DreSRV
    prometheus_web_listen_address: "0.0.0.0:{{ prometheus_port }}"
    prometheus_global:
      scrape_interval: 15s
      scrape_timeout: 10s
      evaluation_interval: 15s
    prometheus_scrape_configs:
      - job_name: "prometheus"
        metrics_path: "{{ prometheus_metrics_path }}"
        static_configs:
          - targets: ["localhost:{{ prometheus_port }}"]
            labels:
              instance: "{{ server_label }}"

      - job_name: "cadvisor"
        static_configs:
          - targets: ["localhost:{{ cadvisor_port }}"]
            labels:
              instance: "{{ server_label }}"

      - job_name: "node"
        static_configs:
          - targets: ["localhost:{{ node_port }}"]
            labels:
              instance: "{{ server_label }}"
          - targets: ["{{ desktop_ip }}:9100"]
            labels:
              instance: "{{ desktop_label }}"

      - job_name: "aquaero"
        scrape_interval: 30s
        static_configs:
          - targets: ["{{ desktop_ip }}:2782"]
            labels:
              instance: "{{ desktop_label }}"

      - job_name: "wmi"
        static_configs:
          - targets: ["{{ desktop_ip }}:9182"]
            labels:
              instance: "{{ desktop_label }}"

      - job_name: "nvidia"
        scrape_interval: 30s
        static_configs:
          - targets: ["{{ desktop_ip }}:9401"]
            labels:
              instance: "{{ desktop_label }}"

      - job_name: 'postgres'
        scrape_interval: 60s
        static_configs:
          - targets: ['localhost:{{ psqlexporter_port }}']
            labels:
              instance: "{{ server_label }}"

      - job_name: 'nginx'
        scrape_interval: 60s
        static_configs:
          - targets: ['localhost:{{ nginxexporter_port }}']
            labels:
              instance: "{{ server_label }}"

      - job_name: "romeo-tv"
        scheme: https
        scrape_interval: 30s
        tls_config:
          ca_file: /etc/prometheus/tls/{{ tls_ca_file }}
          cert_file: /etc/prometheus/tls/{{ tls_crt_file }}
          key_file: /etc/prometheus/tls/{{ tls_key_file }}
        static_configs:
          - targets: ['{{ rtv_domain }}:7766']
            labels:
              job: "cadvisor"
              instance: "RomeoTV"
              __metrics_path__: /cadvisor/metrics

          - targets: ['{{ rtv_domain }}:7766']
            labels:
              job: "node"
              instance: "RomeoTV"
              __metrics_path__: /node/metrics

    grafana_skip_install: true
    grafana_url: "https://{{ grafana_domain }}/grafana/"
    grafana_instance: "localhost"
    grafana_address: "127.0.0.1"
    grafana_port: 3001
    grafana_security:
      admin_user: "{{ grafana_admin_user }}"
      admin_password: "{{ grafana_admin_pass }}"
    grafana_smtp:
      host: "{{ smtp_host }}:{{ smtp_port }}"
      user: "{{ smtp_user }}"
      password: "{{ smtp_pass }}"
      from_address: "{{ grafana_smtp_from }}"
    grafana_database:
      type: postgres
      host: localhost:5432
      user: grafana
      password: "{{ grafana_psql_pass }}"
    grafana_datasources:
      - name: "Prometheus"
        type: "prometheus"
        access: "proxy"
        url: "http://localhost:{{ prometheus_port }}/"
        basicAuth: false
    grafana_dashboards: []
  roles:
    # - { role: prometheus }
    - { role: grafana }
