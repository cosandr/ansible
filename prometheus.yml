---
- name: Prometheus Stack playbook
  gather_facts: true
  diff: yes
  hosts: localhost
  connection: local
  vars_files: .secrets/vars.yml
  vars:
    prometheus_version: latest
    prometheus_skip_install: true
    tls_ca_file: ca.crt
    tls_crt_file: dresrv.crt
    tls_key_file: dresrv.key
    prometheus_port: 9092
    node_port: 9100
    cadvisor_port: 8081
    psqlexporter_port: 9187
    nginxexporter_port: 9113
    prometheus_web_listen_address: "0.0.0.0:{{ prometheus_port }}"
    prometheus_targets:
      romeotv:
        - targets: ['{{ rtv_domain }}:7766']
          labels:
            job: "romeo-tv"
            __metrics_path__: /cadvisor/metrics

        - targets: ['{{ rtv_domain }}:7766']
          labels:
            job: "romeo-tv"
            __metrics_path__: /node/metrics
    prometheus_scrape_configs:
      - job_name: "prometheus"
        metrics_path: "{{ prometheus_metrics_path }}"
        static_configs:
          - targets:
              - "localhost:{{ prometheus_port }}"

      - job_name: "node"
        static_configs:
          - targets:
              - "localhost:{{ node_port }}"

      - job_name: "romeo-tv"
        file_sd_configs:
          - files:
            - "{{ prometheus_config_dir }}/file_sd/romeotv.yml"
        scheme: https
        scrape_interval: 20s
        tls_config:
          ca_file: /etc/prometheus/tls/{{ tls_ca_file }}
          cert_file: /etc/prometheus/tls/{{ tls_crt_file }}
          key_file: /etc/prometheus/tls/{{ tls_key_file }}

      - job_name: 'cadvisor'
        scrape_interval: 5s
        static_configs:
          - targets: ['localhost:{{ cadvisor_port }}']

      - job_name: 'psqlexporter'
        scrape_interval: 15s
        static_configs:
          - targets: ['localhost:{{ psqlexporter_port }}']

      - job_name: 'nginxexporter'
        scrape_interval: 10s
        static_configs:
          - targets: ['localhost:{{ nginxexporter_port }}']
    grafana_skip_install: true
    grafana_instance: "localhost"
    grafana_domain: "localhost"
    grafana_port: 3001
    grafana_security:
      admin_user: admin
      admin_password: "{{ grafana_admin_pass }}"
    grafana_database:
      type: postgres
      host: localhost:5432
      user: grafana
      password: "{{ grafana_psql_pass }}"
    grafana_datasources:
      - name: "Prometheus"
        type: "prometheus"
        access: "proxy"
        url: "http://localhost:{{ prometheus_port }}/"
        basicAuth: false
    grafana_dashboards: []
  roles:
    # - { role: prometheus }
    - { role: grafana }
