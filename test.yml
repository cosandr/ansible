---
- name: Test Playbook
  gather_facts: true
  check_mode: true
  diff: yes
  hosts: all
  vars_files: 
    - .secrets/vars.yml
    - host_vars/server.yml
    # - role_vars/systemd.yml
  vars:
    systemd_no_check_missing: true
    systemd_units:
      - name: timer-no-service-undefined
        timer:
          timer:
            onbootsec: 30
      - name: empty-service-undefined
      - name: basic-service-defined
        service:
          service:
            exec_start: [ "/bin/cat /etc/shadow" ]
  tasks:
    # - name: "Ansible | List all known variables and facts"
    #   debug:
    #     var: hostvars[inventory_hostname]
    - name: Merge ports
      set_fact:
        ports: "{{ ports | combine(_ports, recursive=true) }}"
    - block:
      - name: "Docker ports"
        debug:
          var: ansible_local.docker.ports

      - name: Merge Docker ports
        set_fact:
          ports: "{{ ports | combine(ansible_local.docker.ports, recursive=true) }}"
    
      when: ansible_local is defined and ansible_local.docker is defined and ansible_local.docker.ports is defined

    - name: "All ports"
      debug:
        var: ports

    - import_role: { name: nginx }
      tags: ["nginx"]
  
    - import_role: { name: systemd }
      tags: ["systemd"]
    
    # - name: Set authorized ssh key, extracting just that data from 'users'
    #   debug:
    #     msg: "{{ item.0.name }}\n{{ item.1 }}"
    #   with_subelements:
    #      - "{{ users }}"
    #      - authorized
