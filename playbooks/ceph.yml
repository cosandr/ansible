#!/usr/bin/env -S ansible-playbook
---

- name: Ceph configuration
  hosts: ceph
  gather_facts: false
  tasks:
    - name: Run on only one host
      run_once: true
      block:
        - name: Deploy RGW service
          ceph_orch_apply:
            spec: "{{ lookup('template', inventory_dir + '/files/ceph/rgw-main.yml.j2') }}"

        - name: Read SSL cert from localgw
          delegate_to: localgw01
          ansible.builtin.slurp:
            path: "{{ item }}"
          loop:
            - "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
            - "/etc/letsencrypt/live/{{ domain }}/privkey.pem"
          register: __certs

        - name: Deploy RGW ingress service
          ceph_orch_apply:
            spec: "{{ lookup('template', inventory_dir + '/files/ceph/rgw-main-ingress.yml.j2') }}"
          vars:
            rgw_ingress_ssl_cert: |
              {{ (__certs.results[0].content | b64decode).strip() }}
              {{ (__certs.results[1].content | b64decode).strip() }}
