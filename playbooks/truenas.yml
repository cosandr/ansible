---

- name: Create NFS share on TrueNAS
  hosts: truenas
  gather_facts: false
  pre_tasks:
    - name: Prepare shares
      set_fact:
        truenas_config_sharing_nfs: "{{ paths | create_nfs_models(hosts, kwargs=kwargs, shares=truenas_config_sharing_nfs) }}"
      vars:
        paths:
          - "/mnt/tank"
          - "/mnt/tank/archive"
          - "/mnt/tank/backup"
          - "/mnt/tank/borg"
          - "/mnt/tank/downloads"
          - "/mnt/tank/games"
          - "/mnt/tank/media"
          - "/mnt/tank/media/photo"
          - "/mnt/tank/media/motion"
          - "/mnt/tank/yes"
        hosts: "{{ groups['backup'] | map('extract', hostvars, 'ansible_host') + [ hostvars['desktop'].ansible_host, hostvars['dresrv'].ansible_host ] }}"
        kwargs:
          maproot_user: root
          maproot_group: wheel
      tags: ["nfs"]

  tasks:
    - name: Configure NFS shares
      spatiumcepa.truenas.truenas_api_sharing_nfs:
        model: "{{ item.model }}"
        state: "{{ item.state | default('present') }}"
      loop: "{{ truenas_config_sharing_nfs }}"
