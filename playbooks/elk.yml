---

- hosts: elk
  gather_facts: true
  roles:
    - role: cosandr.dnf_automatic
      tags: ["dnf_automatic"]

    - role: node_exporter
      tags: ["node_exporter"]

    - role: firewall_config
      tags: ["firewall"]
      when: firewall_rules is defined

- hosts: elasticsearch
  gather_facts: true
  roles:
    - role: setup_disks
      tags: ["disk"]

    - role: elastic.elasticsearch
      vars:
        ansible_distribution: RedHat
      tags: ["elasticsearch"]

    - role: elastic_exporter
      tags: ["elastic_exporter"]

- hosts: logstash
  gather_facts: true
  roles:
    - role: logstash
      tags: ["logstash"]

- hosts: kibana
  gather_facts: true
  roles:
    - role: kibana
      tags: ["kibana"]


- name: Prepare target hosts group
  hosts: all
  become: false
  gather_facts: false
  vars:
    skip_hosts:
      - dresrv
      - drepi  # filebeat role doesn't support arm yet
      - romsto
  tasks:
    - name: Add hosts with filebeat configured
      run_once: true
      add_host:
        name: "{{ item }}"
        group: log_hosts
      loop: "{{ groups['all'] }}"
      when:
        - item not in skip_hosts
        - hostvars[item].filebeat_config is defined
        - hostvars[item].filebeat_config | length > 0
      tags: ["always"]

- hosts: log_hosts
  roles:
    - role: filebeat
      tags: ["filebeat"]
