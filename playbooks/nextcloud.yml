---

- hosts: nextcloud
  gather_facts: true
  pre_tasks:
    - name: Disable some default services
      firewalld:
        zone: "{{ item.zone }}"
        service: "{{ item.service }}"
        permanent: true
        state: disabled
      loop:
        - zone: public
          service: cockpit
      notify: reload firewalld
      tags: ["firewalld"]

    - name: Allow Prometheus to node exporter
      firewalld:
        zone: public
        rich_rule: rule family=ipv4 source address={{ hostvars['prom01'].ansible_host }} port port={{ node_exporter_port }} protocol=tcp accept
        permanent: true
        state: enabled
      notify: reload firewalld
      tags: ["node_exporter"]

    - name: Install rclone
      dnf:
        name: rclone
        state: present
      tags: ["rclone"]
  roles:
    - role: setup_disks
      tags: ["disk"]

    - role: cosandr.dnf_automatic
      tags: ["dnf_automatic"]

    - role: firewalld_webgw
      tags: ["firewalld"]

    - role: cosandr.nextcloud
      tags: ["nextcloud"]

    - role: systemd
      tags: ["systemd", "rclone"]

    - role: node_exporter
      tags: ["node_exporter"]

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded
