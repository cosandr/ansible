#!/usr/bin/env -S ansible-playbook
---

- name: Prepare target hosts group
  hosts: all
  become: false
  gather_facts: false
  tasks:
    - name: Add hosts with configured backups
      run_once: true
      add_host:
        name: "{{ item }}"
        group: backup_hosts
      loop: "{{ groups['all'] }}"
      when:
        - hostvars[item].borg_backups is defined
        - hostvars[item].borg_backups | length > 0
      tags: ["always"]

- name: Setup borg on target hosts
  become: true
  gather_facts: false
  hosts: backup_hosts
  pre_tasks:
    - name: Run common role
      become: false
      import_role:
        name: common
      tags: ["always"]

    - name: Gather facts
      setup:
      tags: ["always"]

    - name: Generate SSH keys for root user
      openssh_keypair:
        path: /root/.ssh/id_ed25519
        comment: "root@{{ inventory_hostname }}"
        type: ed25519
      register: __ssh_key
      tags: ["ssh"]

    - name: Scan SSH host key for borg server
      command: "ssh-keyscan {{ hostvars[item].ansible_host }}"
      check_mode: false
      changed_when: false
      loop: "{{ groups['backup'] }}"
      register: __host_keys
      tags: ["ssh"]

    - name: Ensure host keys are in known_hosts
      blockinfile:
        path: /root/.ssh/known_hosts
        create: true
        mode: 0644
        block: |
          {% for h in __host_keys.results %}
          {{ h.stdout }}
          {% endfor %}
      tags: ["ssh"]

  roles:
    - role: borg
      when: not (borg_server | default(false))
      tags: ["borg"]

- name: Setup borg on backup server
  become: true
  hosts: backup
  pre_tasks:
    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]

    - name: Append hosts
      set_fact:
        borg_auth_users: "{{ borg_auth_users + [{ 'host': hostvars[item].ansible_hostname, 'key': hostvars[item].__ssh_key.public_key }] }}"
      loop: "{{ groups['backup_hosts'] }}"
      when:
        - hostvars[item].__ssh_key is defined
        - item != inventory_hostname
      tags: ["ssh"]

    - name: Create borg home
      file:
        path: "{{ borg_home }}"
        owner: "{{ borg_uid }}"
        group: "{{ borg_gid }}"
        mode: 0700
        state: directory
      tags: ["nfs", "borg"]

    - name: Mount tank NFS share
      mount:
        src: "{{ hostvars['theia'].local_ips.vm }}:/mnt/tank"
        path: "/mnt/tank"
        opts: "defaults,vers=4,ro,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["nfs"]

    - name: Mount Borg NFS share
      mount:
        src: "{{ hostvars['theia'].local_ips.vm }}:/mnt/tank/borg/repos"
        path: "{{ borg_pool }}"
        opts: "defaults,vers=4,rw,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["nfs"]

  roles:
    - role: borg
      tags: ["borg"]
