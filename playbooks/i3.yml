#!/usr/bin/env -S ansible-playbook
---
- name: Override ansible_connection if needed
  import_playbook: prep_local.yml
  tags: ["always"]

- hosts: gui
  gather_facts: true
  tasks:
    - name: Merge pacman packages
      set_fact:
        pacman_packages: "{{ pacman_packages + __pacman_packages }}"
      when:
        - pacman_packages is defined
        - __pacman_packages is defined
      tags: ["always"]

    - name: Merge aur packages
      set_fact:
        aur_packages: "{{ aur_packages + __aur_packages }}"
      when:
        - aur_packages is defined
        - __aur_packages is defined
      tags: ["always"]

    - name: Update system
      become: true
      pacman:
        update_cache: true
        upgrade: true
        extra_args: "--ignore {{ ignored_packages | join(',') }}"

    - name: Install Pacman packages
      become: true
      pacman:
        name: "{{ pacman_packages }}"
        state: present
      when:
        - pacman_packages is defined
        - pacman_packages | length > 0

    - name: Install paru
      aur:
        name: paru
        state: present

    - name: Install AUR packages
      aur:
        name: "{{ aur_packages }}"
        state: present
      when:
        - aur_packages is defined
        - aur_packages | length > 0
