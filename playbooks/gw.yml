---

- hosts: dresrv
  gather_facts: false
  pre_tasks:
    - name: Run common role
      import_role:
        name: common
      tags: ["always"]

    - name: Merge ports
      set_fact:
        ports: "{{ ports | combine(_ports, recursive=true) }}"
      tags: ["always"]

    - name: Gather facts
      setup:
      tags: ["always"]

    - name: Merge Docker ports
      set_fact:
        ports: "{{ ports | combine(ansible_local.docker.ports, recursive=true) }}"
      when: ansible_local.docker is defined and ansible_local.docker.ports is defined
      tags: ["always"]
  tasks:
    - name: Ensure route_localnet is set
      sysctl:
        name: "net.ipv4.conf.{{ wireguard_interface }}.route_localnet"
        value: '1'
        state: present

    - name: Configure firewalld
      blockinfile:
        path: /etc/firewalld/direct.xml
        insertafter: '^<direct.*>$'
        marker: "<!--{mark} ANSIBLE MANAGED BLOCK-->"
        # marker: "{{ '{mark} ANSIBLE MANAGED BLOCK' | comment('xml') }}"
        block: |
          {% for p in ports.values() %}
            <rule ipv="ipv4" table="nat" chain="PREROUTING" priority="0">-p tcp -d {{ hostvars['ovh-gw01'].wireguard_address }} --dport {{ p }} -j DNAT --to-destination 127.0.0.1:{{ p }}</rule>
          {% endfor %}
      notify: reload firewalld

  handlers:
    - name: reload firewalld
      systemd:
        name: firewalld
        state: reloaded
