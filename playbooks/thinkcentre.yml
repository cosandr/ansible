#!/usr/bin/env -S ansible-playbook
---

- name: Configure ThinkCentre machines
  hosts: thinkcentre
  pre_tasks:
    - name: Install packages
      ansible.builtin.dnf:
        name: "{{ dnf_packages }}"
        state: present
      tags: ["dnf"]
  roles:
    - role: grub
      tags: ["grub"]

    - role: systemd_cryptenroll
      tags: ["cryptenroll"]

    - role: systemd_networkd
      tags: ["networkd"]

    - role: auto_ssh
      tags: ["auto-ssh"]

    - role: btrbk
      tags: ["btrbk"]
  tasks:
    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]

    - name: Include hypervisor tasks
      ansible.builtin.include_tasks:
        file: ../tasks/kvm_hypervisors.yml
        apply:
          tags: ["hypervisor"]
      tags: ["always"]

    - name: Configure systemd-resolved
      ansible.builtin.lineinfile:
        dest: "/etc/systemd/resolved.conf"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      notify: Restart systemd-resolved
      loop:
        - regexp: "^#?DNS="
          line: "DNS={{ all_net.mgmt.cidr | ansible.utils.ipaddr('1') | ansible.utils.ipaddr('address') }}"
        - regexp: "^#?FallbackDNS"
          line: "FallbackDNS=1.1.1.1,8.8.8.8"
      tags: ["resolved"]

  handlers:
    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved.service
        state: restarted
