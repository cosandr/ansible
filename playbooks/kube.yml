#!/usr/bin/env -S ansible-playbook
---

- name: Configure Kubernetes nodes
  gather_facts: true
  hosts: k8s_cluster
  tags: ["system"]
  tasks:
    - name: Stop firewalld
      systemd:
        name: firewalld
        state: stopped
      tags: ["firewalld"]

    - name: Disable firewalld
      systemd:
        name: firewalld
        enabled: false
      tags: ["firewalld"]

    - name: Mask firewalld
      systemd:
        name: firewalld
        masked: true
      tags: ["firewalld"]

    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]

- name: Deploy charts and manifests
  hosts: k8s_cluster[0]
  gather_facts: false
  pre_tasks:
    - name: Install Helm diff plugin
      delegate_to: localhost
      kubernetes.core.helm_plugin:
        plugin_path: https://github.com/databus23/helm-diff
        state: present
      tags: ["helm", "plugins"]
  vars:
    helm_repos:
      - name: nfs-subdir-external-provisioner
        repo_url: "https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner"
      - name: prometheus-community
        repo_url: "https://prometheus-community.github.io/helm-charts"
  tasks:
    - name: Run on localhost
      delegate_to: localhost
      block:
        - name: Add helm repos
          kubernetes.core.helm_repository:
            name: "{{ item.name }}"
            repo_url: "{{ item.repo_url }}"
          loop: "{{ helm_repos }}"
          loop_control:
            label: "{{ item.name }}"
          tags: ["helm", "repos"]

        - name: Deploy NFS provisioner
          kubernetes.core.helm:
            name: nfs-provisioner
            chart_ref: nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
            release_namespace: kube-system
            release_values:
              storageClass.defaultClass: true
              nfs.server: "{{ hostvars['theia'].local_ips.vm }}"
              nfs.path: "/srv/kube"
          tags: ["helm", "nfs"]

        - name: Deploy Prometheus chart
          kubernetes.core.helm:
            name: prometheus
            chart_ref: prometheus-community/kube-prometheus-stack
            release_namespace: prometheus
            create_namespace: true
            release_values:
              alertmanager:
                enabled: false
              grafana:
                enabled: false
              prometheus:
                service:
                  type: LoadBalancer
                  loadBalancerIP: "10.0.15.21"
                prometheusSpec:
                  externalLabels: {}
                  externalUrl: "http://10.0.15.21:9090"
                  retention: 1h
                  storageSpec:
                    emptyDir:
                      sizeLimit: "512Mi"
              prometheus-node-exporter:
                extraArgs:
                  - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
                  - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$
                  - --collector.systemd
                extraHostVolumeMounts:
                  - name: systemd
                    hostPath: /run/dbus/system_bus_socket
                    mountPath: /var/run/dbus/system_bus_socket
                    readOnly: true
                    mountPropagation: None
          tags: ["helm", "prometheus"]

        - name: Configure nginx ingress LB
          kubernetes.core.k8s:
            resource_definition: "{{ lookup('template', inventory_dir + '/files/k8s/nginx-lb.yml.j2') | from_yaml }}"
          tags: ["nginx"]
