#!/usr/bin/env -S ansible-playbook
---
- name: SSH
  hosts: drepi
  gather_facts: true
  vars:
    ansible_ssh_pass: raspberry  # fresh install
  tasks:
    # Set up ssh
    # https://github.com/hannseman/ansible-raspbian
    - name: Add SSH keys
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ item }}"
        state: present
      with_items: "{{ ssh_authorized_keys }}"
      tags: ["ssh"]

  roles:
    - role: sshd
      vars:
        _sshd_pkg: "openssh-server"
      become: true
      tags: ["sshd"]

- name: Raspberry Pi 4 playbook
  gather_facts: false
  become: true
  hosts: drepi
  vars:
    system_timezone: "Europe/Oslo"
    system_locale: "en_US.UTF-8"
  pre_tasks:
    - name: Run common role
      become: false
      ansible.builtin.import_role:
        name: common
      tags: ["always"]

    - name: Gather facts
      ansible.builtin.setup:
      tags: ["always"]

    - name: Configure motion
      block:
        - name: Mount motion share
          ansible.posix.mount:
            src: "{{ hostvars['truenas'].local_ips.general }}:/mnt/tank/media/motion"
            path: "/mnt/motion"
            opts: "defaults,vers=4,rw,noatime,bg"
            state: mounted
            fstype: nfs

        - name: Ensure camera is enabled
          ansible.builtin.lineinfile:
            dest: "/boot/config.txt"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
          notify: Reboot
          with_items:
            - regexp: "^#?start_x"
              line: "start_x=1"
            - regexp: "^#?gpu_mem"
              line: "gpu_mem=128"

        # NOTE: might need 'sudo rpi-update'
        # - name: Ensure kernel module is loaded at boot
        #   ansible.builtin.lineinfile:
        #     dest: "/etc/modules-load.d/modules.conf"
        #     regexp: "^#?bcm2835-v4l2"
        #     line: "bcm2835-v4l2"
        #     state: present
        #   notify: Reboot

      tags: ["motion"]

  tasks:
    - name: Configure interactive shell stuff
      block:
        - name: Install vim
          ansible.builtin.apt:
            name: vim
            state: present

        - name: Configure bashrc
          ansible.builtin.blockinfile:
            path: /etc/bash.bashrc
            block: |
              export EDITOR=vim
              alias ll='ls -lh'
              alias la='ll -A'

      tags: ["bash", "vim"]

    - name: Configure locale
      block:
        - name: Set timezone
          ansible.builtin.timezone:
            name: "{{ system_timezone }}"

        - name: Ensure locale exists
          ansible.builtin.locale_gen:
            name: "{{ system_locale }}"
            state: present
          notify: Update locale

        - name: Set default system locale
          ansible.builtin.debconf:
            name: 'locales'
            question: 'locales/default_environment_locale'
            vtype: 'string'
            value: "{{ system_locale }}"
          notify: Update locale

      tags: ["locale"]

  roles:
    - role: hostname
      tags: ["hostname"]

    - role: firewall_config
      tags: ["ufw", "firewall"]

    - role: motion
      tags: ["motion"]

    - role: node_exporter
      tags: ["node_exporter"]

    - role: unattended-upgrades
      tags: ["unattended-upgrades"]

  post_tasks:
    - name: Configure postfix
      block:
        - name: Install mailx and postfix
          ansible.builtin.apt:
            name:
              - bsd-mailx
              - postfix
              - libsasl2-modules
            state: present

        # NOTE: manually run dpgk-reconfigure postfix
        - name: Configure postfix
          ansible.builtin.lineinfile:
            dest: "/etc/postfix/main.cf"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
          with_items:
            - regexp: "^#?mydomain"
              line: "mydomain = {{ domain }}"
            - regexp: "^#?myhostname"
              line: "myhostname = {{ inventory_hostname }}.{{ domain }}"
            - regexp: "^#?myorigin"
              line: "myorigin = $mydomain"
            - regexp: "^#?relay_domains"
              line: "relay_domains = {{ smtp_relay_domains | map(attribute='relay_host') | unique | join(', ') }}, {{ smtp_relay_domains | map(attribute='name') | join(', ') }}"
            - regexp: "^#?relayhost"
              line: "relayhost = [{{ smtp_relay_domains[0].relay_host }}]"
            - regexp: "^#?sender_dependent_relayhost_maps"
              line: "sender_dependent_relayhost_maps = hash:/etc/postfix/relayhost_map"
            - regexp: "^#?smtp_use_tls"
              line: "smtp_use_tls = yes"
            - regexp: "^#?smtp_sasl_auth_enable"
              line: "smtp_sasl_auth_enable = yes"
            - regexp: "^#?smtp_sasl_security_options"
              line: "smtp_sasl_security_options = noanonymous, noplaintext"
            - regexp: "^#?smtp_sasl_password_maps"
              line: "smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd"
            - regexp: "^#?smtp_tls_CAfile"
              line: "smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt"
            - regexp: "^#?smtp_pix_workarounds"
              line: "smtp_pix_workarounds = delay_dotcrlf"
            - regexp: "^#?smtp_sasl_mechanism_filter"
              line: "smtp_sasl_mechanism_filter ="
            - regexp: "^#?smtp_sasl_tls_security_options"
              line: "smtp_sasl_tls_security_options = $smtp_sasl_security_options"
            - regexp: "^#?smtp_sasl_type"
              line: "smtp_sasl_type = cyrus"
            - regexp: "^#?smtp_sender_dependent_authentication"
              line: "smtp_sender_dependent_authentication = yes"
            - regexp: "^#?smtpd_sasl_path"
              line: "smtpd_sasl_path = smtpd"
            - regexp: "^#?smtpd_sasl_type"
              line: "smtpd_sasl_type = cyrus"
            - regexp: "^#?soft_bounce"
              line: "soft_bounce = no"
            - regexp: "^#?transport_maps"
              line: "transport_maps = hash:/etc/postfix/transport"
            - regexp: "^#?unknown_local_recipient_reject_code"
              line: "unknown_local_recipient_reject_code = 550"
            - regexp: "^#?virtual_alias_maps"
              line: "virtual_alias_maps = hash:/etc/postfix/virtual"
          notify: Restart postfix

        - name: Ensure virtual file exists
          ansible.builtin.file:
            state: touch
            path: /etc/postfix/virtual
            owner: root
            group: root
            mode: 0600
            modification_time: preserve
            access_time: preserve
          notify:
            - Regenerate virtual.db
            - Restart postfix

        - name: Configure postfix transport
          ansible.builtin.copy:
            dest: /etc/postfix/transport
            owner: root
            group: root
            mode: 0600
            content: |
              {% for d in smtp_relay_domains %}
              .{{ d.name }}    smtp:[{{ d.relay_host }}]:587
              {% endfor %}
          notify:
            - Regenerate transport.db
            - Restart postfix

        - name: Configure postfix relayhost_map
          ansible.builtin.copy:
            dest: /etc/postfix/relayhost_map
            owner: root
            group: root
            mode: 0600
            content: |
              {% for d in smtp_relay_domains %}
              @{{ d.name }}    [{{ d.relay_host }}]:587
              {% endfor %}
          notify:
            - Regenerate relayhost_map.db
            - Restart postfix

        - name: Configure postfix sasl_password
          ansible.builtin.copy:
            dest: /etc/postfix/sasl_passwd
            owner: root
            group: root
            mode: 0600
            content: |
              {% for d in smtp_relay_domains %}
              @{{ d.name }}    {{ d.user }}:{{ d.password }}
              {% endfor %}
          notify:
            - Regenerate sasl_passwd.db
            - Restart postfix
      tags: ["postfix"]

  handlers:
    - name: Reboot
      ansible.builtin.reboot: {}

    - name: Update locale
      ansible.builtin.command: "/usr/sbin/update-locale LANG={{ system_locale }}"

    - name: Regenerate virtual.db
      ansible.builtin.command: "/usr/sbin/postmap /etc/postfix/virtual"

    - name: Regenerate transport.db
      ansible.builtin.command: "/usr/sbin/postmap /etc/postfix/transport"

    - name: Regenerate relayhost_map.db
      ansible.builtin.command: "/usr/sbin/postmap /etc/postfix/relayhost_map"

    - name: Regenerate sasl_passwd.db
      ansible.builtin.command: "/usr/sbin/postmap /etc/postfix/sasl_passwd"

    - name: Restart postfix
      ansible.builtin.systemd:
        name: postfix
        state: restarted
