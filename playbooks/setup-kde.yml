#!/usr/bin/env -S ansible-playbook
---

- hosts: laptop
  gather_facts: false
  vars:
    desktop_environment: "kde"
    __startup_script_path: "/home/{{ my_user }}/.config/plasma-workspace/env"
  pre_tasks:
    - name: Run common role
      import_role:
        name: common
      tags: ["always"]

    # - name: Gather facts
    #   setup:
    #   tags: ["always"]

  tasks:
    - name: Enable HiDPI in SDDM
      become: true
      copy:
        content: |
          [Wayland]
          EnableHiDPI=true

          [X11]
          EnableHiDPI=true
        dest: "/etc/sddm.conf.d/hidpi.conf"
        owner: root
        group: root
        mode: 0644
      tags: ["sddm"]

    - name: Configure SDDM DPI
      become: true
      copy:
        content: |
          [X11]
          ServerArguments=-nolisten tcp -dpi 192
        dest: "/etc/sddm.conf.d/dpi.conf"
        owner: root
        group: root
        mode: 0644
      tags: ["sddm"]

    - name: Ensure startup script dir exists
      file:
        path: "{{ __startup_script_path }}"
        owner: "{{ my_user }}"
        group: "{{ my_user }}"
        mode: 0755
        state: directory
      tags: ["scripts"]

    - name: Copy startup scripts
      copy:
        content: |
          #!/bin/bash

          {{ item.content }}
        dest: "{{ __startup_script_path }}/{{ item.name }}.sh"
        owner: "{{ my_user }}"
        group: "{{ my_user }}"
        mode: 0755
      loop: "{{ plasma_startup_scripts }}"
      tags: ["scripts"]

    # Doing it seperately because I'm not sure if the key is the same across installations
    - name: Configure Konsole shortcut
      lineinfile:
        path: "/home/{{ my_user }}/.config/kglobalshortcutsrc"
        backrefs: true
        regexp: '^(.*)=([^,]+)(.*)Launch Konsole$'
        line: '\1=Meta+Return\3Launch Konsole'
      tags: ["shortcuts"]

    - name: Configure global shortcuts
      lineinfile:
        path: "/home/{{ my_user }}/.config/kglobalshortcutsrc"
        backrefs: true
        regexp: '^({{ item.key | regex_escape() }})=([^,]+)(.*)$'
        line: '\1={{ item.value }}\3'
      with_dict: "{{ kde_global_shortcuts }}"
      tags: ["shortcuts"]

    - name: Write KDE configs
      become: true
      become_user: "{{ my_user }}"
      changed_when: false
      command: "kwriteconfig5 {{ item }}"
      loop: "{{ kde_configs }}"
      tags: ["kconfig"]
