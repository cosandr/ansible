---

- name: Configure SSH
  hosts: webgw
  gather_facts: false
  pre_tasks:
    - name: Check if we can connect on configured port
      wait_for:
        port: "{{ ansible_port }}"
        state: "started"
        host: "{{ ansible_host }}"
        connect_timeout: 2
        timeout: 4
      delegate_to: "localhost"
      ignore_errors: true
      check_mode: false
      register: __configured_ssh
      tags: ["sshd"]

  roles:
    - role: change_ssh_port
      when:
        - ansible_port != 22
        - __configured_ssh is defined
        - __configured_ssh.state is undefined
      tags: ["sshd"]

- name: Configure gateways
  hosts: webgw
  gather_facts: true
  pre_tasks:
    - name: Enable SELinux
      selinux:
        policy: targeted
        state: enforcing
      register: __selinux_state
      when: ansible_os_family == 'RedHat'
      tags: ["selinux"]

    - name: Reboot if required
      reboot:
      when:
        - __selinux_state is defined
        - __selinux_state.reboot_required
      tags: ["selinux"]

    - name: Install epel
      dnf:
        name: epel-release
        state: present
      tags: ["install"]
      when: ansible_os_family == 'RedHat'

    - name: Ensure nginx directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: 0755
      loop:
        - "{{ nginx_dhparam | dirname }}"
        - "{{ nginx_sites_logs }}"
      tags: ["nginx"]

    - name: Download dhparam
      get_url:
        url: https://ssl-config.mozilla.org/ffdhe2048.txt
        dest: "{{ nginx_dhparam }}"
        mode: 0644
        owner: root
        group: root
      tags: ["nginx"]

    - name: Install nginx repo
      copy:
        dest: /etc/yum.repos.d/nginx.repo
        content: |
          [nginx-stable]
          name=nginx stable repo
          baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
          gpgcheck=1
          enabled=1
          gpgkey=https://nginx.org/keys/nginx_signing.key
          module_hotfixes=true

          [nginx-mainline]
          name=nginx mainline repo
          baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
          gpgcheck=1
          enabled=0
          gpgkey=https://nginx.org/keys/nginx_signing.key
          module_hotfixes=true
        owner: root
        group: root
        mode: 0644
      tags: ["nginx"]

    - name: Allow nginx proxy
      seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true
      when:
        - ansible_os_family == 'RedHat'
        - ansible_selinux.status == "enabled"
      tags: ["nginx"]

    - name: Add logrotate config for sites
      copy:
        content: |
          {{ nginx_sites_logs }}/*.log {
                  daily
                  missingok
                  rotate 7
                  compress
                  delaycompress
                  notifempty
                  create 640 nginx adm
                  sharedscripts
                  postrotate
                          if [ -f /var/run/nginx.pid ]; then
                                  kill -USR1 `cat /var/run/nginx.pid`
                          fi
                  endscript
          }
        dest: /etc/logrotate.d/nginx_sites
        owner: root
        group: root
        mode: 0644
      tags: ["nginx", "logrotate"]

    - name: Set fail2ban facts
      set_fact:
        fail2ban_ignoreip: "{{ (__f2b_extra_ignore + hostvars['laptop'].wireguard_mt_allowed_ips) | flatten }}"
      tags: ["fail2ban"]
  roles:
    - role: sshd
      tags: ["sshd"]

    - role: ufw
      when: ansible_os_family == 'Debian'
      tags: ["ufw"]

    - role: fail2ban
      tags: ["fail2ban"]

    - role: unattended-upgrades
      when: ansible_os_family == 'Debian'
      tags: ["unattended-upgrades"]

    - role: cosandr.dnf_automatic
      when: ansible_os_family == 'RedHat'
      tags: ["dnf_automatic"]

    - role: node_exporter
      tags: ["node_exporter"]

    - role: filebeat
      when:
        - filebeat_config is defined
        - filebeat_config | length > 0
      tags: ["filebeat"]

    - role: certbot
      vars:
        certbot_domains: "{{ certbot_domains_hetzner }}"
        certbot_credentials_path: "/etc/letsencrypt/hetzner.ini"
        certbot_credentials_content: |
          dns_hetzner_api_token = {{ vault_dns_hetzner_api_token }}

        certbot_generate_command: >
          certbot certonly
          --authenticator dns-hetzner
          --dns-hetzner-credentials {{ certbot_credentials_path }}
          -n
          --keep
          --expand
      when:
        - certbot_domains_hetzner is defined
        - certbot_domains_hetzner | length > 0
      tags: ["certbot", "hetzner"]

    - role: certbot
      vars:
        certbot_install: "{{ __certbot_installed is not defined }}"
        certbot_domains: "{{ certbot_domains_cloudflare }}"
        certbot_credentials_path: "/etc/letsencrypt/cloudflare.ini"
        certbot_credentials_content: |
          dns_cloudflare_api_token = {{ vault_dns_cloudflare_api_token }}

        certbot_generate_command: >
          certbot certonly
          --authenticator dns-cloudflare
          --dns-cloudflare-credentials {{ certbot_credentials_path }}
          -n
          --keep
          --expand
      when:
        - certbot_domains_cloudflare is defined
        - certbot_domains_cloudflare | length > 0
      tags: ["certbot", "cloudflare"]

    - role: nginx
      tags: ["nginx"]

    - role: nginx_exporter
      tags: ["nginx_exporter"]

    - role: wireguard
      when: wireguard_address is defined
      tags: ["wireguard"]
  tasks:
    - block:
        - name: Install firewalld
          dnf:
            name: firewalld
            state: present
          tags: ["install"]

        - name: Remove cockpit from public zone
          firewalld:
            zone: "public"
            service: "cockpit"
            permanent: true
            state: disabled
          notify: reload firewalld

        - name: Add http and https to public zone
          firewalld:
            zone: "public"
            service: "{{ item }}"
            permanent: true
            state: enabled
          loop:
            - "http"
            - "https"
          notify: reload firewalld

        - name: Enable masquerade on configured zones
          firewalld:
            zone: "{{ item }}"
            masquerade: true
            permanent: true
            state: enabled
          loop: "{{ firewalld_masquerade_zones }}"
          notify: reload firewalld

        - name: Configure rich rules
          firewalld:
            zone: "{{ item.zone | default('public') }}"
            rich_rule: "{{ item.rich_rule }}"
            permanent: true
            state: enabled
          notify: reload firewalld
          loop: "{{ firewalld_rich_rules }}"

        - name: Add Wireguard interface to internal zone
          firewalld:
            zone: "internal"
            interface: "{{ wireguard_interface }}"
            permanent: true
            state: enabled
          when: wireguard_interface is defined
          notify: reload firewalld

        - name: Allow wireguard through firewall
          firewalld:
            zone: "public"
            port: "{{ wireguard_port }}/udp"
            permanent: true
            state: enabled
          when: wireguard_port is defined
          notify: reload firewalld

        - name: Add prom server to internal zone
          firewalld:
            zone: "internal"
            source: "{{ hostvars['prom01'].ansible_host }}"
            permanent: true
            state: enabled
          when: wireguard_address is not defined
          notify: reload firewalld

        - name: Add ports to internal zone
          firewalld:
            zone: internal
            port: "{{ item }}/tcp"
            permanent: true
            state: enabled
          loop:
            - "{{ node_exporter_port }}"
            - "{{ nginx_exporter_port }}"
          notify: reload firewalld

      tags: ["firewalld"]
      when: ansible_os_family == 'RedHat'

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded
