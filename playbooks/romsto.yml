#!/usr/bin/env -S ansible-playbook
---
- name: Romsto playbook
  gather_facts: false
  hosts: romsto
  pre_tasks:
    - name: Run common role
      import_role:
        name: common
      tags: ["always"]

    - name: Gather facts
      setup:
      tags: ["always"]
  post_tasks:
    - block:
        - name: Compress filebeat
          archive:
            path:
              - "{{ filebeat_config_path }}"
              - "{{ filebeat_home_path }}"
              - "{{ sysv_path }}/rc.filebeat"
            dest: /boot/filebeat.tar.gz

        - name: Setup filebeat on boot
          blockinfile:
            path: /boot/config/go
            marker: "# {mark} filebeat"
            block: |
              tar zxf /boot/filebeat.tar.gz -C /
              install -o root -g root -dm755 {{ filebeat_log_path }}
              {{ sysv_path }}/rc.filebeat start
      tags: ["filebeat"]
  roles:
    # - role: node_exporter
    #   vars:
    #     node_exporter_skip_install: false
    #     node_exporter_no_sysusers: true
    #     node_exporter_version: "latest"
    #     node_exporter_port: "{{ ports.node_exporter }}"
    #     node_exporter_collectors: []

    #   tags: ["prometheus-stack", "node_exporter"]

    - role: nginx_site
      tags: ["nginx_site"]

    - role: filebeat
      tags: ["filebeat"]
