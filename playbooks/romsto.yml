#!/usr/bin/env -S ansible-playbook
---

- name: Romsto playbook
  gather_facts: false
  hosts: romsto
  vars:
    data_disk:
      dev: "/dev/disk/by-label/datassd01"
      path: "/mnt/disks/datassd01"
      script: "/boot/config/plugins/user.scripts/scripts/0-mount-datassd/script"
    persistent_disk:
      dev: "/dev/disk/by-label/pstore"
      path: "/pstore"
    swap_disk: "/dev/disk/by-uuid/eee1d5fb-be1e-4344-a1c7-9a3d3d990b53"
    ssd_mount_opts: "space_cache=v2,compress-force=zstd,relatime,ssd,discard=async"
  pre_tasks:
    - name: Run common role
      import_role:
        name: common
      tags: ["always"]

    - name: Gather facts
      setup:
      tags: ["always"]
  tasks:
    - name: Setup extra SSD
      blockinfile:
        path: /boot/config/go
        marker: "# {mark} datassd"
        block: |
          # Enable swap partition
          swapon -d {{ swap_disk }}

          # Mount persistent data partition
          mkdir -p {{ persistent_disk.path }}
          mount -o {{ ssd_mount_opts }} {{ persistent_disk.dev }} {{ persistent_disk.path }}

          # Mount unassigned data partition
          mkdir -p {{ data_disk.path }}
          mount -o {{ ssd_mount_opts }} {{ data_disk.dev }} {{ data_disk.path }}
      tags: ["go", "datassd"]

    - name: Ensure user script dir exists
      file:
        path: "{{ data_disk.script | dirname }}"
        state: directory
        owner: root
        group: root
        mode: 0700
      tags: ["datassd"]

    - name: Ensure data SSD is mounted on array start
      copy:
        dest: "{{ data_disk.script }}"
        owner: root
        group: root
        mode: 0700
        content: |
          #!/bin/bash

          #name=0-mount-datassd
          #description=Ensure {{ data_disk.path | basename }} is mounted
          #arrayStarted=true
          #noParity=true

          if ! grep -q '{{ data_disk.path | regex_escape() }}' /proc/mounts; then
            mkdir -p {{ data_disk.path }}
            mount -o {{ ssd_mount_opts }} {{ data_disk.dev }} {{ data_disk.path }}
          fi
      tags: ["datassd"]
  roles:
    - role: nginx_site
      tags: ["nginx_site"]

    - role: promtail
      tags: ["promtail"]
  post_tasks:
    - name: Ensure promtail is persistent
      block:
        - name: Copy promtail rc file
          copy:
            src: /etc/rc.d/rc.promtail
            remote_src: true
            dest: /pstore/promtail/rc.promtail
            owner: root
            group: root
            mode: 0755

        - name: Copy promtail logrotate config
          copy:
            src: /etc/logrotate.d/promtail
            remote_src: true
            dest: /pstore/promtail/promtail.logrotate
            owner: root
            group: root
            mode: 0644

        - name: Setup promtail on boot
          blockinfile:
            path: /boot/config/go
            marker: "# {mark} promtail"
            block: |
              install -o root -g root -m755 /pstore/promtail/rc.promtail /etc/rc.d/rc.promtail
              install -o root -g root -m644 /pstore/promtail/promtail.logrotate /etc/logrotate.d/promtail
              /etc/rc.d/rc.promtail start

      tags: ["promtail", "go"]
