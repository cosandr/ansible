#!/usr/bin/env -S ansible-playbook
---

- name: Romsto playbook
  hosts: romsto
  tasks:
    - name: Setup extra SSD
      ansible.builtin.blockinfile:
        path: /boot/config/go
        marker: "# {mark} datassd"
        block: |
          # Enable swap partition
          swapon -d {{ swap_disk }}

          # Mount persistent data partition
          mkdir -p {{ persistent_disk.path }}
          mount -o {{ ssd_mount_opts }} {{ persistent_disk.dev }} {{ persistent_disk.path }}

          # Mount unassigned data partition
          mkdir -p {{ data_disk.path }}
          mount -o {{ ssd_mount_opts }} {{ data_disk.dev }} {{ data_disk.path }}
      tags: ["go", "datassd"]

    - name: Ensure user script dir exists
      ansible.builtin.file:
        path: "{{ data_disk.script | dirname }}"
        state: directory
        owner: root
        group: root
        mode: "0700"
      tags: ["datassd"]

    - name: Ensure data SSD is mounted on array start
      ansible.builtin.copy:
        dest: "{{ data_disk.script }}"
        owner: root
        group: root
        mode: "0700"
        content: |
          #!/bin/bash

          #name=0-mount-datassd
          #description=Ensure {{ data_disk.path | basename }} is mounted
          #arrayStarted=true
          #noParity=true

          if ! grep -q '{{ data_disk.path | regex_escape() }}' /proc/mounts; then
            mkdir -p {{ data_disk.path }}
            mount -o {{ ssd_mount_opts }} {{ data_disk.dev }} {{ data_disk.path }}
          fi
      tags: ["datassd"]
  roles:
    - role: nginx_site
      tags: ["nginx_site"]

    - role: promtail
      tags: ["promtail"]
  post_tasks:
    - name: Ensure promtail is persistent
      tags: ["promtail", "go"]
      block:
        - name: Copy promtail rc file
          ansible.builtin.copy:
            src: /etc/rc.d/rc.promtail
            remote_src: true
            dest: "{{ persistent_disk.path }}/promtail/rc.promtail"
            owner: root
            group: root
            mode: "0755"

        - name: Copy promtail logrotate config
          ansible.builtin.copy:
            src: /etc/logrotate.d/promtail
            remote_src: true
            dest: "{{ persistent_disk.path }}/promtail/promtail.logrotate"
            owner: root
            group: root
            mode: "0644"

        - name: Setup promtail on boot
          ansible.builtin.blockinfile:
            path: /boot/config/go
            marker: "# {mark} promtail"
            block: |
              install -o root -g root -m755 {{ persistent_disk.path }}/promtail/rc.promtail /etc/rc.d/rc.promtail
              install -o root -g root -m644 {{ persistent_disk.path }}/promtail/promtail.logrotate /etc/logrotate.d/promtail
              /etc/rc.d/rc.promtail start
