---

- hosts: truenas
  gather_facts: false
  vars:
    pg_share:
      paths: ["/mnt/tank/backup/pgsql"]
      comment: ""
      hosts: "{{ groups['pg'] | map('extract', hostvars, 'ansible_host') }}"
      alldirs: true
      ro: false
      quiet: false
      maproot_user: root
      maproot_group: wheel
      enabled: true
    pgbackrest_share:
      paths: ["/mnt/tank/backup/pgbackrest"]
      comment: "Pgbackrest shares"
      hosts: "{{ groups['pgbackrest'] | map('extract', hostvars, 'ansible_host') }}"
      alldirs: true
      ro: false
      quiet: false
      maproot_user: root
      maproot_group: wheel
      enabled: true
  tasks:
    - name: Configure shares
      spatiumcepa.truenas.truenas_api_sharing_nfs:
        model: "{{ item }}"
        state: present
      loop:
        - "{{ pg_share }}"
        - "{{ pgbackrest_share }}"

- hosts: db
  roles:
    - role: setup_disks
      tags: ["disk"]

    - role: node_exporter
      vars:
        # Configured by firewall role
        node_exporter_config_firewall: false
      tags: ["node_exporter"]

    - role: cosandr.dnf_automatic
      tags: ["dnf_automatic"]

    - role: firewall_config
      tags: ["firewall"]

    - role: pgbackrest
      tags: ["pgbackrest"]

    - role: auto_ssh
      tags: ["auto-ssh"]

- hosts: pg
  gather_facts: true
  vars:
    postgres_exporter_version: "latest"
  pre_tasks:
    - name: Mount NFS share
      mount:
        src: "{{ hostvars['truenas'].local_ips.vm }}:/mnt/tank/backup/pgsql"
        path: "/mnt/backup-pgsql"
        opts: "defaults,vers=4,rw,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["nfs"]

  roles:
    - role: postgresql
      tags: ["pg"]

    - role: postgres_exporter
      vars:
        postgres_service_name: "{{ postgresql_daemon }}"
      tags: ["prometheus-stack", "postgres_exporter"]

    - role: systemd
      tags: ["systemd"]

- hosts: pgbackrest
  pre_tasks:
    - name: Mount NFS share
      mount:
        src: "{{ hostvars['truenas'].local_ips.vm }}:/mnt/tank/backup/pgbackrest"
        path: "/var/lib/pgbackrest"
        opts: "defaults,vers=4,rw,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["nfs"]
