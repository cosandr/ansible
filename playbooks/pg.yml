---

# TODO: Configure NFS share on Theia for /mnt/tank/backup/pgbackrest

- hosts: db
  pre_tasks:
    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]
  roles:
    - role: pgbackrest
      tags: ["pgbackrest"]

    - role: auto_ssh
      tags: ["auto-ssh"]

- hosts: pg
  gather_facts: true
  vars:
    postgres_exporter_version: "latest"

  roles:
    - role: postgresql
      tags: ["pg"]

    - role: postgres_exporter
      vars:
        postgres_service_name: "{{ postgresql_daemon }}"
      tags: ["prometheus-stack", "postgres_exporter"]

- hosts: pgbackrest
  pre_tasks:
    - name: Mount NFS share
      mount:
        src: "{{ hostvars['theia'].local_ips.vm }}:/mnt/tank/backup/pgbackrest"
        path: "/var/lib/pgbackrest"
        opts: "defaults,vers=4,rw,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["nfs"]
