---


- hosts: ovh
  gather_facts: false
  vars:
    api_url: "https://api.domeneshop.no/v0"
    records:
      - type: A
        target: "{{ ansible_host }}"
      - type: AAAA
        target: "{{ ipv6_address }}"
  pre_tasks:
    - name: Get domains from API
      uri:
        url: "{{ api_url }}/domains"
        user: "{{ domeneshop_token }}"
        password: "{{ domeneshop_secret }}"
        force_basic_auth: true
      check_mode: false
      register: ds_domains

    - name: Get DNS records from API
      uri:
        url: "{{ api_url }}/domains/{{ item.id }}/dns"
        user: "{{ domeneshop_token }}"
        password: "{{ domeneshop_secret }}"
        force_basic_auth: true
      loop: "{{ ds_domains.json }}"
      loop_control:
        label: "{{ item.domain }}"
      when: item.domain in domains
      check_mode: false
      register: ds_records

  tasks:
    - name: Delete extra A/AAAA DNS records
      uri:
        url: "{{ api_url }}/domains/{{ item.id }}/dns/{{ item.1.id }}"
        user: "{{ domeneshop_token }}"
        password: "{{ domeneshop_secret }}"
        force_basic_auth: true
      loop: "{{ ds_records | product(ds_records.json) | list }}"
      loop_control:
         label: "{{ item.0.item.domain }} [{{ item.1.type }}]"
      when: item.domain in domains
    # - name: Add records
    #   uri:
    #     url: "{{ api_url }}/domains/{{ item.0.id }}/dns"
    #     method: POST
    #     body:
    #       host: "@"
    #       ttl: 3600
    #       type: "{{ item.1.type }}"
    #       data: "{{ item.1.target }}"
    #     body_format: json
    #     status_code: 201
    #     user: "{{ domeneshop_token }}"
    #     password: "{{ domeneshop_secret }}"
    #     force_basic_auth: true
    #   loop: "{{ ds_domains.json | product(records) | list }}"
    #   loop_control:
    #     label: "{{ item.0.domain }} [{{ item.1.type }}]"
    #   when: item.0.domain in domains
