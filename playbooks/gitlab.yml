---

- hosts: gitlab
  gather_facts: true
  roles:
    - role: setup_disks
      tags: ["disk"]

    - role: firewall_config
      tags: ["firewall"]

    - role: geerlingguy.gitlab
      tags: ["gitlab"]

    - role: cosandr.dnf_automatic
      tags: ["dnf_automatic"]

  post_tasks:
    - name: Add garbage collection job
      template:
        src: "{{ inventory_dir }}/files/gitlab/registry-garbage-collect.timer.j2"
        dest: "/etc/systemd/system/registry-garbage-collect.timer"
        owner: root
        group: root
        mode: 0644
      notify:
        - reload systemd
        - enable and start garbage collection
      tags: ["gitlab", "gc"]

    - name: Copy garbage collection service
      copy:
        src: "{{ inventory_dir }}/files/gitlab/registry-garbage-collect.service"
        dest: "/etc/systemd/system/registry-garbage-collect.service"
        owner: root
        group: root
        mode: 0644
      notify: reload systemd
      tags: ["gitlab", "gc"]

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: true

    - name: enable and start garbage collection
      systemd:
        name: registry-garbage-collect.timer
        state: started
        enabled: true
