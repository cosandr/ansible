---

- hosts: gitlab
  gather_facts: true
  pre_tasks:
    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]
  roles:
    - role: geerlingguy.gitlab
      tags: ["gitlab"]

    - role: systemd
      tags: ["systemd"]

  post_tasks:
    # Required for gitlab backup to work
    - name: Ensure tar is installed
      ansible.builtin.dnf:
        name: tar
        state: present

    - name: Mount backup NFS share
      mount:
        src: "{{ hostvars['theia'].local_ips.vm }}:/mnt/tank/backup/gitlab"
        path: "{{ gitlab_backup_upload_connection.local_root }}"
        opts: "defaults,vers=4,rw,noatime,bg"
        state: mounted
        fstype: nfs
      tags: ["gitlab", "nfs"]

    - name: Ensure git owns backup mount
      file:
        path: "{{ gitlab_backup_upload_connection.local_root }}"
        owner: git
        group: git
        mode: 0750
        state: directory
      tags: ["gitlab", "nfs"]

    - name: Ensure correct SELinux context for git .ssh
      sefcontext:
        target: "/var/opt/gitlab/.ssh(/.*)?"
        setype: ssh_home_t
        state: present
      notify: restore git contexts
      when: ansible_selinux.status == "enabled"
      tags: ["gitlab", "selinux"]

    - name: Add garbage collection job
      template:
        src: "{{ inventory_dir }}/files/gitlab/registry-garbage-collect.timer.j2"
        dest: "/etc/systemd/system/registry-garbage-collect.timer"
        owner: root
        group: root
        mode: 0644
      notify:
        - reload systemd
        - enable and start garbage collection
      tags: ["gitlab", "gc"]

    - name: Copy garbage collection service
      copy:
        src: "{{ inventory_dir }}/files/gitlab/registry-garbage-collect.service"
        dest: "/etc/systemd/system/registry-garbage-collect.service"
        owner: root
        group: root
        mode: 0644
      notify: reload systemd
      tags: ["gitlab", "gc"]

  handlers:
    - name: restore git contexts
      command: restorecon -r /var/opt/gitlab/.ssh

    - name: reload systemd
      systemd:
        daemon_reload: true

    - name: enable and start garbage collection
      systemd:
        name: registry-garbage-collect.timer
        state: started
        enabled: true

- hosts: gitrun
  pre_tasks:
    - name: Set Gitlab URL fact
      set_fact:
        gitlab_external_url: "https://gitlab.{{ hostvars['gitlab01'].domain }}"
      tags: ["runner"]

  roles:
    - role: gitlab_runner
      tags: ["runner"]
