#!/usr/bin/env -S ansible-playbook
---

- name: Setup Docker Swarm nodes
  hosts: swarm
  pre_tasks:
    - name: Include common tasks
      ansible.builtin.include_tasks:
        file: ../tasks/common_servers.yml
      tags: ["always"]
  roles:
    - role: ceph_client
      tags: ["ceph"]

    - role: geerlingguy.docker
      tags: ["docker"]

    - role: keepalived
      tags: ["keepalived"]

  post_tasks:
    - name: Enable daemon cluster mode SELinux boolean
      ansible.posix.seboolean:
        name: daemons_enable_cluster_mode
        state: true
        persistent: true
      when:
        - ansible_os_family == 'RedHat'
        - ansible_selinux.status == "enabled"
      tags: ["keepalived"]

    - name: Mount CephFS
      ansible.posix.mount:
        src: swarm@.cephfs=/swarm
        path: /mnt/ceph
        fstype: ceph
        opts: "noatime"
        state: mounted
      tags: ["ceph"]

    - name: Mount media share
      ansible.posix.mount:
        src: "{{ hostvars['theia'].host_ips.vm }}:/mnt/tank/media"
        path: "/mnt/media"
        opts: "defaults,noatime"
        state: mounted
        fstype: nfs
      tags: ["nfs"]

    - name: Setup swarm
      tags: ["swarm"]
      block:
        - name: Check if swarm is active
          run_once: true
          ansible.builtin.command:
            cmd: "{% raw %}docker node ls --format '{{ .Hostname }}'{% endraw %}"
          check_mode: false
          changed_when: false
          failed_when: false
          register: __swarm_nodes

        - name: Initialize swarm
          run_once: true
          ansible.builtin.command:
            cmd: docker swarm init
          when:
            - '"This node is not a swarm manager" in __swarm_nodes.stderr'
          register: __swarm_init

        - name: Get join token
          run_once: true
          ansible.builtin.command:
            cmd: docker swarm join-token manager -q
          changed_when: false
          register: __swarm_token
          when:
            - "inventory_hostname not in __swarm_nodes.stdout"

        - name: Join nodes
          ansible.builtin.command:
            cmd: "docker swarm join --token {{ __swarm_token.stdout }} {{ hostvars[groups['swarm'][0]].ansible_host }}:2377"
          when:
            - inventory_hostname != groups['swarm'][0]
            - "inventory_hostname not in __swarm_nodes.stdout"

    - name: Configure registries
      tags: ["registry"]
      block:
        - name: Check if config file exists
          ansible.builtin.stat:
            path: "/root/.docker/config.json"
          register: __docker_config

        - name: Read docker config
          ansible.builtin.slurp:
            path: "/root/.docker/config.json"
          register: __docker_config_content
          when: __docker_config.stat.exists

        - name: Set docker config fact
          ansible.builtin.set_fact:
            __docker_config_json: "{{ __docker_config_content.content | b64decode | from_json }}"
          when: __docker_config_content.content | default('')

        - name: Login to registries
          ansible.builtin.command:
            cmd: "docker login --username {{ item.username }} --password-stdin {{ item.url }}"
            stdin: "{{ item.password }}"
          loop: "{{ docker_registries }}"
          loop_control:
            label: "{{ item.url }} [{{ item.username }}]"
          when: not __docker_config.stat.exists or item.url not in __docker_config_json.auths
