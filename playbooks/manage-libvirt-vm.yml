#!/usr/bin/env -S ansible-playbook
---

- name: Manage VMs
  hosts: libvirt
  gather_facts: false
  pre_tasks:
    # Maybe have this a group... who designed this inventory??
    - name: Set fact for all VM hosts
      ansible.builtin.set_fact:
        vm_hosts: "{{ groups['libvirt'] | map('extract', hostvars, 'vm_host') | list | select('defined') | list | unique }}"
      tags: ["always"]

    - name: Get list of VMs on all hosts
      run_once: true
      check_mode: false
      delegate_to: "{{ item }}"
      community.libvirt.virt:
        state: "{{ 'running' if 'stop' in ansible_run_tags else 'shutdown' }}"
        command: list_vms
      register: __vm_names
      loop: "{{ vm_hosts }}"
      tags: ["always"]

    - name: Find current host for self
      ansible.builtin.set_fact:
        current_host: "{{ __vm_names.results | selectattr('list_vms', 'search', inventory_hostname) | map(attribute='item') | list | first }}"
      tags: ["always"]

  tasks:
    - name: "{{ 'Shutting down' if 'stop' in ansible_run_tags else 'Starting up' }}"
      delegate_to: "{{ current_host }}"
      community.libvirt.virt:
        name: "{{ inventory_hostname }}"
        state: "{{ 'shutdown' if 'stop' in ansible_run_tags else 'running' }}"
      tags: ["start", "stop"]
