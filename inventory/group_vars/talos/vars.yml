---

host_num: "{{ groups[(host_subnet == 'control_plane') | ternary('talos_cp', 'talos_worker')] | ansible.utils.index_of('eq', inventory_hostname) }}"

__host_ips_3:
  san: "{{ subnets.san.talos | ansible.utils.ipv4 | andrei.utils.ipaddr_concat(groups['talos'] | ansible.utils.index_of('eq', inventory_hostname)) }}"

# https://github.com/siderolabs/talos/releases
talos_version: "1.11.0"
# https://kubernetes.io/releases/
kube_version: "1.33.4"

talos_schedule_on_control_plane: true
talos_kubeprism_enabled: true
talos_kubeproxy_enabled: false
talos_kubeproxy_mode: ipvs
kube_proxy_enabled: false
kube_api_server: "{{ domain }}"
kube_ingress_domain: "{{ domain }}"

# https://www.talos.dev/v1.11/talos-guides/install/boot-assets/#image-factory
# curl -X POST --data-binary @schematic.yml https://factory.talos.dev/schematics
# customization:
#   extraKernelArgs:
#     - console=ttyS0
#   systemExtensions:
#     officialExtensions:
#       - siderolabs/qemu-guest-agent
#       - siderolabs/zfs
__basic_talos_schematic: 54ce56c26a6ff61064b025503a07349972f26927780f809a4a7812ad34000226
# customization:
#   extraKernelArgs:
#     - console=ttyS0
#   systemExtensions:
#     officialExtensions:
#       - siderolabs/qemu-guest-agent
#       - siderolabs/zfs
#       - siderolabs/i915
__igpu_talos_schematic: 4bcf050fc47fe673b1fcd6376b47e72fbe02db5b48c97ba84f97cf8c29818d88
# customization:
#   extraKernelArgs:
#     - console=ttyS0
#   systemExtensions:
#     officialExtensions:
#       - siderolabs/qemu-guest-agent
#       - siderolabs/zfs
#       - siderolabs/nvidia-container-toolkit-production
#       - siderolabs/nvidia-open-gpu-kernel-modules-production
__nvidia_talos_schematic: 8863ebeedd0a553d9455b165e72a97afb12da0d0346304a845fed5f748f27167
talos_schematic: >-
  {%- if __igpu_vm_pci_devices == vm_pci_devices -%}
  {{ __igpu_talos_schematic }}
  {%- elif __nvidia_vm_pci_devices == vm_pci_devices -%}
  {{ __nvidia_talos_schematic }}
  {%- else -%}
  {{ __basic_talos_schematic }}
  {%- endif -%}

talos_image: "factory.talos.dev/installer/{{ talos_schematic }}:v{{ talos_version }}"

talos_kubectl_context: "admin@{{ kube_api_server }}"
enable_admin_pods: true

node_labels: >-
  {%- set tmp = {
    "cluster-type": 'talos',
    "cpu-tier": hostvars[vm_host].cpu_tier | string,
    "vm-host": vm_host
  } -%}
  {%- if host_subnet == 'worker' -%}
  {{- tmp.update({"node-role.kubernetes.io/worker": ""}) -}}
  {%- endif -%}
  {%- if __igpu_vm_pci_devices == vm_pci_devices -%}
  {{- tmp.update({"intel.feature.node.kubernetes.io/gpu": "true"}) -}}
  {%- endif -%}
  {%- if __nvidia_vm_pci_devices == vm_pci_devices -%}
  {{- tmp.update({"nvidia.com/gpu.present": "true"}) -}}
  {%- endif -%}
  {{ tmp }}

# Skip for now
prometheus_blackbox_icmp_targets: []
prometheus_node_targets: []

pss_privileged_labels:
  pod-security.kubernetes.io/enforce: privileged
  pod-security.kubernetes.io/audit: privileged
  pod-security.kubernetes.io/warn: privileged
