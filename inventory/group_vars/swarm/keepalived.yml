---

vrrp_nic: "enp1s0"

keepalived_global_defs:
  - enable_script_security

keepalived_scripts:
  check_docker:
    check_script: '/usr/bin/curl --no-buffer -XGET --unix-socket /run/docker.sock http://localhost/_ping'
    user: root

keepalived_selinux_compile_rules:
  - "{{ repo_base_dir }}/files/swarm/keepalived_docker"

keepalived_instances:
  swarm:
    interface: "{{ vrrp_nic }}"
    state: "{{ (groups['swarm'].index(inventory_hostname) == 0) | ternary('MASTER', 'BACKUP') }}"
    virtual_router_id: 60
    priority: "{{ (inventory_hostname == groups['swarm'][0]) | ternary('200', '100') }}"
    unicast_src_ip: "{{ ansible_host }}"
    unicast_peers: "{{ groups['swarm'] | difference([inventory_hostname]) | map('extract', hostvars, 'ansible_host') | list }}"
    authentication_password: "{{ vault_keepalived_authentication_password }}"
    vips:
      - "{{ swarm_vip }} dev {{ vrrp_nic }}"
    track_scripts:
      - check_docker
