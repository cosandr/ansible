---

# https://wiki.debian.org/Bonding#Configuring_the_bond_device
# https://serverfault.com/questions/1106863/bridge-on-a-bonded-interface-with-systemd-networkd
# https://www.reddit.com/r/linux/comments/30hk8e/creating_a_bridge_for_virtual_machines_using/

__bond0_primary_iface: "enp1s0"
__bond0_backup_iface: "eno1"

host_bridge_config:
  mgmt:
    dns: true
    route:
      Metric: 512

# Used for GENERAL and VM where 21, 22 and 23 are taken
__ip_offset: 50

__host_ips:
  general: "{{ all_net.general.cidr | ansible.utils.ipaddr(__host_num | int + __ip_offset) }}"
  mgmt: "{{ all_net.mgmt.cidr | ansible.utils.ipaddr(__host_num) }}"
  san: "{{ subnets.san.hosts | ansible.utils.ipv4 | ipaddr_concat(host_num, prefixlen=24) }}"
  vm: "{{ all_net.vm.cidr | ansible.utils.ipaddr(__host_num | int + __ip_offset) }}"

host_ips: >-
  {%- set tmp = {} -%}
  {%- for k, v in __host_ips.items() -%}
  {{- tmp.update({k: v | ansible.utils.ipaddr('address')}) -}}
  {%- endfor -%}
  {{ tmp }}

__networkd_vlan_netdevs: >-
  {%- set tmp = {} -%}
  {%- for config in all_net.values() if 'vlan' in config -%}
  {{- tmp.update({
    'bond0.' + config.vlan | string: lookup('template', repo_base_dir + '/files/kvm_hv/vlan.netdev.j2', template_vars=config)
    }) -}}
  {%- endfor -%}
  {{ tmp }}

__networkd_bridge_netdevs: >-
  {%- set tmp = {} -%}
  {%- for name, config in all_net.items() if 'vlan' in config -%}
  {{- tmp.update({
      name | upper: lookup('template', repo_base_dir + '/files/kvm_hv/bridge.netdev.j2', template_vars={'name': name, 'config': config})
    }) -}}
  {%- endfor -%}
  {{ tmp }}

__networkd_bond_netdevs:
  bond0: "{{ lookup('template', repo_base_dir + '/files/kvm_hv/bond0.netdev.j2') }}"

networkd_netdevs: "{{ __networkd_bond_netdevs | combine(__networkd_vlan_netdevs, __networkd_bridge_netdevs) }}"

__networkd_vlan_configs: >-
  {%- set tmp = {} -%}
  {%- for name, config in all_net.items() if 'vlan' in config -%}
  {{- tmp.update({
      'bond0.' + config.vlan | string: lookup('template', repo_base_dir + '/files/kvm_hv/bond.network.j2', template_vars={'name': name, 'config': config})
    }) -}}
  {%- endfor -%}
  {{ tmp }}

__networkd_bridge_configs: >-
  {%- set tmp = {} -%}
  {%- for name, config in all_net.items() if 'vlan' in config -%}
  {{- tmp.update({
      name | upper: lookup('template', repo_base_dir + '/files/kvm_hv/bridge.network.j2', template_vars={'name': name, 'config': config})
    }) -}}
  {%- endfor -%}
  {{ tmp }}

__networkd_bond_configs:
  bond0: "{{ lookup('template', repo_base_dir + '/files/kvm_hv/bond0.network.j2') }}"
  bond0_primary: "{{ lookup('template', repo_base_dir + '/files/kvm_hv/bond0_primary.network.j2') }}"
  bond0_backup: "{{ lookup('template', repo_base_dir + '/files/kvm_hv/bond0_backup.network.j2') }}"

networkd_config: "{{ __networkd_bond_configs | combine(__networkd_vlan_configs, __networkd_bridge_configs) }}"
