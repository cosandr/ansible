---

# SELinux might need custom policy
# allow init_t fusermount_exec_t:file { execute open read execute_no_trans map };

__sd_nextcloud_mount:
  name: nextcloud-mount
  service:
    content: |
      [Unit]
      Description=Mount Nextcloud using rclone
      After=network-online.target docker.service
      Requires=network-online.target docker.service

      [Service]
      Type=notify
      User={{ my_user }}
      Group={{ my_user }}
      ExecStartPre=mkdir -p /home/{{ my_user }}/Nextcloud
      ExecStart=rclone mount --dir-cache-time=168h --syslog --poll-interval=1m --vfs-cache-mode=full nextcloud: /home/{{ my_user }}/Nextcloud
      ExecStop=/usr/bin/fusermount -uz /home/{{ my_user }}/Nextcloud
      Restart=on-failure
      RestartSec=5
      TimeoutStopSec=100

      [Install]
      WantedBy=multi-user.target

  timer:
    enabled: true
    state: started
    content: |
      [Unit]
      Description=Mount Nextcloud after boot

      [Timer]
      OnBootSec=15min

      [Install]
      WantedBy=timers.target
