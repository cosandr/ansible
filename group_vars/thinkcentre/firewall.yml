---

firewalld_default_zone: cluster
__cluster_sources:
  - "{{ groups['ceph'] | difference([inventory_hostname]) | map('extract', hostvars, 'host_ips') | map(attribute='san') | list }}"
  - "{{ groups['ceph'] | difference([inventory_hostname]) | map('extract', hostvars, 'host_ips') | map(attribute='mgmt') | list }}"

node_exporter_config_firewall: false

firewalld_zones:
  - name: cluster
    sources: "{{ __cluster_sources | flatten }}"

  - name: internal
    interfaces:
      - MGMT
      - SAN

  - name: public
    interfaces:
      - GENERAL
      - VM
      - NOINET

firewalld_services:
  - name: ssh
    zone: cluster

  - name: nfs3
    zone: cluster

  - name: cockpit
    zone: public
    state: absent

  - name: samba-client
    zone: internal
    state: absent

  - name: samba-client
    zone: public
    state: absent

  - name: nfs3
    zone: internal

  - name: cockpit
    zone: internal
    sources: "{{ firewall_trusted_sources }}"

firewall_rules:
  - port: "{{ node_exporter_port }}"
    zone: internal
    sources: "{{ node_exporter_allow_ips }}"

  - port: "{{ ceph_exporter_port }}"
    zone: internal
    sources: "{{ node_exporter_allow_ips }}"

  - port: "{{ ceph_dashboard_port }}"
    zone: internal
    sources: "{{ firewall_trusted_sources }}"

  # https://wiki.libvirt.org/page/FAQ#What_are_the_different_migration_methods.3F
  - port: "49152-49215"
    protocol: tcp
    zone: cluster
