---

alertmanager_version: latest
alertmanager_port: 9093
alertmanager_web_listen_address: "0.0.0.0:{{ alertmanager_port }}"
alertmanager_web_external_url: "http://{{ ansible_host }}:{{ alertmanager_port }}/"
alertmanager_slack_api_url: "{{ vault_alertmanager_slack_api_url }}"
# https://github.com/prometheus/alertmanager/blob/main/template/default.tmpl
alertmanager_receivers:
  - name: discord
    slack_configs:
      - send_resolved: true
        title: '{% raw %}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}{{ end }}{% endraw %}'
        fields:
          - title: 'Summary'
            value: '{% raw %}{{ if .Alerts }}{{ range .Alerts }}{{ .Annotations.summary }}{{ printf "\n" }}{{ end }}{{ else }}{{ .CommonAnnotations.summary }}{{ end }}{% endraw %}'
            short: false
          - title: 'Description'
            value: '{% raw %}{{ if .Alerts }}{{ range .Alerts }}{{ .Annotations.description }}{{ printf "\n" }}{{ end }}{{ else }}{{ .CommonAnnotations.description }}{{ end }}{% endraw %}'
            short: false

alertmanager_route:
  group_by: ['instance', 'job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 168h
  receiver: discord
  routes:
    - group_by: ["job"]
      group_wait: 10m
      matchers:
        - job=~"blackbox.*"

    - group_wait: 2h
      matchers:
        - alertname="ContainerCpuUsage"
        - name="plex"

alertmanager_inhibit_rules:
  # Only fire one out of memory alert
  - source_matchers:
      - alertname = HostHighMemoryUsage
    target_matchers:
      - alertname = HostOutOfMemory
    equal: ['instance']

  # Silence slow probe is probe failed
  - source_matchers:
      - alertname = BlackboxProbeFailed
    target_matchers:
      - alertname = BlackboxSlowProbe
    equal: ['instance']

  # Inhibit blackbox if node is down
  - source_matchers:
      - alertname = InstanceDown
    target_matchers:
      - job =~ "blackbox.*"
    equal: ['__host_ip']
