---

netmaker_domain: "netmaker.{{ domains[0] }}"
netmaker_master: "{{ vault_netmaker_master }}"
netmaker_home_dir: "/opt/netmaker"
netmaker_compose_file:
  version: "3.4"
  services:
    netmaker:
      privileged: true
      container_name: netmaker
      image: gravitl/netmaker:v0.8
      volumes:
        - "{{ netmaker_home_dir }}/local:/local"
        - /etc/netclient:/etc/netclient
        - "{{ netmaker_home_dir }}/dnsconfig:/root/config/dnsconfig"
        - /usr/bin/wg:/usr/bin/wg
        - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
        - /run/systemd/system:/run/systemd/system
        - /etc/systemd/system:/etc/systemd/system
        - /sys/fs/cgroup:/sys/fs/cgroup
        - "{{ netmaker_home_dir }}/sqldata:/root/data"
      cap_add:
        - NET_ADMIN
        - SYS_MODULE
      restart: always
      network_mode: host
      environment:
        SERVER_HOST: "{{ ansible_host }}"
        SERVER_API_CONN_STRING: "api.{{ netmaker_domain }}:443"
        SERVER_GRPC_CONN_STRING: "grpc.{{ netmaker_domain }}:443"
        COREDNS_ADDR: "{{ ansible_host }}"
        GRPC_SSL: "on"
        DNS_MODE: "on"
        SERVER_HTTP_HOST: "api.{{ netmaker_domain }}"
        SERVER_GRPC_HOST: "grpc.{{ netmaker_domain }}"
        API_PORT: "8081"
        GRPC_PORT: "50051"
        CLIENT_MODE: "on"
        MASTER_KEY: "{{ netmaker_master }}"
        SERVER_GRPC_WIREGUARD: "off"
        CORS_ALLOWED_ORIGIN: "*"
        DATABASE: "sqlite"
    netmaker-ui:
      container_name: netmaker-ui
      depends_on:
        - netmaker
      image: gravitl/netmaker-ui:v0.8
      links:
        - "netmaker:api"
      ports:
        - "8082:80"
      environment:
        BACKEND_URL: "https://api.{{ netmaker_domain }}"
      restart: always
    coredns:
      depends_on:
        - netmaker
      image: coredns/coredns
      command: -conf /root/dnsconfig/Corefile
      container_name: coredns
      restart: always
      ports:
        - "{{ ansible_host }}:53:53/udp"
        - "{{ ansible_host }}:53:53/tcp"
      volumes:
        - "{{ netmaker_home_dir }}/dnsconfig:/root/dnsconfig"
