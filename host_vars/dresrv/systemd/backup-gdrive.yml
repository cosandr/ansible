---

__gdrive_exclude:
  - 'PS3-Backup/**'
  - 'external-os/**'
  - 'vcenter/**'
  - 'truenas/**'
  - 'macrium/**'
  - 'theia/**'

__sd_backup_gdrive:
  name: backup-gdrive
  service:
    content: |
      [Unit]
      Description=Backup important files to Google Drive
      After=network-online.target tank.mount
      Requires=network-online.target tank.mount
      ConditionPathExists={{ container_data }}/syncthing/data
      ConditionPathExists=/tank/backup

      [Service]
      Type=oneshot
      ExecStart=rclone sync -v {{ container_data }}/syncthing/data gsecret:syncthing
      ExecStart=rclone sync -v --exclude '{{ '{' }}{{ __gdrive_exclude | join(',') }}{{ '}' }}' /tank/backup gsecret:tank-backup

      [Install]
      WantedBy=multi-user.target

  # Daily at 05:00
  timer:
    enabled: true
    state: started
    content: |
      [Unit]
      Description=Backup important files to Google Drive timer

      [Timer]
      Persistent=yes
      OnCalendar=*-*-* 05:00:00

      [Install]
      WantedBy=timers.target
