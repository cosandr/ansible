---

__sd_fix_libvirtd_nat:
  name: fix-libvirtd-nat
  service:
    content: |
      [Unit]
      Description=Set up iptables after libvirtd
      After=libvirtd.service firewalld.service
      Wants=libvirtd.service firewalld.service

      [Service]
      Type=oneshot
      # Allow forwarding on entire libvirt interface
      ExecStart=iptables -I FORWARD -o virbr0 -d 192.168.122.0/24 -j ACCEPT
      # Forward SSH for srvsim VM
      ExecStart=iptables -t nat -I PREROUTING -p tcp --dport 222 -j DNAT --to 192.168.122.2:22
      ExecStart=iptables -t nat -I PREROUTING -p tcp --dport 2222 -j DNAT --to 192.168.122.2:2222
      # Forward Windows 10 VM RDP
      ExecStart=iptables -t nat -I PREROUTING -p tcp --dport 3389 -j DNAT --to 192.168.122.3:3389
      # Forward SSH for arch VM
      ExecStart=iptables -t nat -I PREROUTING -p tcp --dport 224 -j DNAT --to 192.168.122.4:22
      ExecStart=iptables -t nat -I PREROUTING -p tcp --dport 2224 -j DNAT --to 192.168.122.4:2222

      [Install]
      WantedBy=multi-user.target

  timer:
    enabled: true
    state: started
    content: |
      [Unit]
      Description=Set up iptables on boot

      [Timer]
      OnBootSec=30

      [Install]
      WantedBy=timers.target
