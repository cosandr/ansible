---
borg_remote_passphrase: "{{ vault_borg_remote_passphrase }}"
borg_server_passphrase: "{{ hostvars['backup01'].borg_server_passphrase }}"

borg_local_repo: false
borg_server: false
borg_auth_users:
  - host: desktop
    key: "{{ hostvars.desktop.ssh_keys.root }}"
  - host: rtv
    key: "{{ hostvars.romsto.ssh_keys.root }}"
borg_backups:
  - name: "root"
    timer_description: "Backup root every Friday at 22:00"
    oncalendar: "Fri *-*-* 22:00:00"
    passphrase: "{{ borg_server_passphrase }}"
    repo: "{{ hostvars['backup01'].borg_remote_repo }}/{{ ansible_hostname }}"
    backup_name: "root"
    pre_run: |
      if ! ssh -q -o "BatchMode=yes" {{ hostvars['backup01'].borg_user }}@{{ hostvars['backup01'].ansible_host }} exit &>/dev/null
      then
          echo "Cannot SSH into remote server"
          exit 1
      fi
    paths:
      - "/"
      - "/boot"
      - "/boot/efi"
      - "/srv"
      - "/var"
      - "/home"
    create_args:
      - "--stats"
      - "--show-rc"
      - "--compression auto,zstd"
      - "--exclude-caches"
      - "--one-file-system"
      - "--exclude '/**/.snapshots'"
      - "--exclude 're:^(/dev|/proc|/sys|/tmp|/run)'"
      - "--exclude '/home/*/.cache'"
      - "--exclude '/home/*/.ccache'"
      - "--exclude '/home/{{ my_user }}/Nextcloud'"
    prune_args:
      - "--list"
      - "--show-rc"
      - "--keep-daily 2"
      - "--keep-weekly 2"
      - "--keep-monthly 6"
  - name: "remote-root"
    timer_description: "Backup root to remote location every 7 days at 04:00"
    oncalendar: "*-*-01/7 04:00:00"
    passphrase: "{{ borg_remote_passphrase }}"
    repo: "{{ hostvars['romsto'].borg_remote_repo }}/{{ ansible_hostname }}/root"
    backup_name: "root"
    pre_run: |
      if ! ssh -q -o "BatchMode=yes" {{ hostvars['romsto'].borg_user }}@{{ hostvars['romsto'].wireguard_ip }} exit &>/dev/null
      then
          echo "Cannot SSH into remote server"
          exit 1
      fi
      # Take snapshots
      snap_paths=(
        "/"
        "/srv"
        "/var"
        "/home"
      )
      mkdir -p /.snapshots/borg_tmp
      cd /.snapshots/borg_tmp
      for p in "${snap_paths[@]}"; do
          [[ $p == / ]] && snap_name="root" || snap_name="$(basename "$p")"
          btrfs subvolume snapshot -r "$p" "$snap_name"
      done
    post_run: |
      cd /
      for p in /.snapshots/borg_tmp/*; do
          btrfs subvolume delete "$p"
      done
      rmdir /.snapshots/borg_tmp
    paths:
      - "."
      - "/boot"
      - "/boot/efi"
    create_args:
      - "--stats"
      - "--show-rc"
      - "--compression auto,zstd"
      - "--exclude-caches"
      - "--exclude '**/.snapshots'"
      - "--exclude 'home/*/.cache'"
      - "--exclude 'home/*/.ccache'"
      - "--remote-ratelimit 20000"
    prune_args:
      - "--list"
      - "--show-rc"
      - "--keep-weekly 3"
      - "--keep-monthly 6"
