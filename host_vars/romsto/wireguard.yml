---

wireguard_port: "51820"
wireguard_interface: "wg0"
wireguard_addresses:
  - "{{ wg_net.mt.cidr | ansible.utils.ipaddr('206') }}"
  # - "{{ wg_net.mt.cidr6 | ansible.utils.ipaddr('0x206' | int(base=16)) }}"

wireguard_mt_allowed_ips:
  - "{{ hostvars['mt-router'].wireguard_ip }}/32"
  - "{{ hostvars['dresrv'].ansible_host }}/32"
  - "{{ hostvars['prom01'].ansible_host }}/32"
  - "{{ hostvars['backup01'].ansible_host }}/32"
  - "{{ hostvars['loki01'].ansible_host }}/32"
  # - "{{ hostvars['mt-router'].wireguard_ipv6 }}/128"

wireguard_address: "{{ wireguard_addresses | join(', ') }}"
wireguard_ip: "{{ wireguard_addresses[0] | ansible.utils.ipaddr('address') }}"
wireguard_private_key: "{{ vault_wireguard_private_key }}"
wireguard_public_key: "{{ vault_wireguard_public_key }}"

wireguard_unmanaged_peers:
  mt:
    endpoint: "{{ hostvars['mt-router'].wireguard_endpoint }}"
    allowed_ips: "{{ wireguard_mt_allowed_ips | join(', ') }}"
    public_key: "{{ hostvars['mt-router'].wireguard_public_key }}"
  webgw:
    endpoint: "{{ hostvars['webgw01'].wireguard_endpoint }}"
    allowed_ips: "{{ hostvars['webgw01'].wireguard_ip }}/32"
    public_key: "{{ hostvars['webgw01'].wireguard_public_key }}"

wireguard_endpoint: ""
wireguard_persistent_keepalive: "30"
wireguard_postup:
  - logger -t wireguard 'Tunnel WireGuard-{{ wireguard_interface }} started'
  - iptables -t nat -A POSTROUTING -s "{{ wg_net.mt.cidr }}" -o br0 -j MASQUERADE
wireguard_postdown:
  - logger -t wireguard 'Tunnel WireGuard-{{ wireguard_interface }} stopped'
  - iptables -t nat -D POSTROUTING -s "{{ wg_net.mt.cidr }}" -o br0 -j MASQUERADE
