# https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
---

crds:
  upgradeJob:
    enabled: true

extraManifests:
  - apiVersion: gateway.envoyproxy.io/v1alpha1
    kind: SecurityPolicy
    metadata:
      name: alertmanager-allowlist
    spec:
      targetRefs:
      - group: gateway.networking.k8s.io
        kind: HTTPRoute
        name: prometheus-kube-prometheus-alertmanager
      authorization:
        defaultAction: Deny
        rules:
        - action: Allow
          principal:
            clientCIDRs: {{ firewall_trusted_sources | to_json }}

  - apiVersion: gateway.envoyproxy.io/v1alpha1
    kind: SecurityPolicy
    metadata:
      name: prometheus-allowlist
    spec:
      targetRefs:
      - group: gateway.networking.k8s.io
        kind: HTTPRoute
        name: prometheus-kube-prometheus-prometheus
      authorization:
        defaultAction: Deny
        rules:
        - action: Allow
          principal:
            clientCIDRs: {{ (firewall_trusted_sources + node_exporter_allow_ips) | to_json }}

alertmanager:
  enabled: true
  route:
    main:
      enabled: true
      hostnames:
        - "am.{{ kube_ingress_domain }}"
      parentRefs:
        - name: envoy
          namespace: envoy-gateway-system

  alertmanagerSpec:
    externalUrl: "http://am.{{ kube_ingress_domain }}"
    retention: 192h
    resources:
      requests:
        cpu: 10m
        memory: 128Mi
      limits:
        memory: 128Mi
    persistentVolumeClaimRetentionPolicy:
      whenDeleted: Delete
      whenScaled: Delete
    storage:
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          storageClassName: rbd-ec
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 64Mi

  templateFiles: {{ alertmanager_template_files | to_json }}

  config:
    route:
      repeat_interval: 168h
{% if vault_alertmanager_discord_webhook_url is defined %}
      receiver: discord
{% else %}
      receiver: 'null'
{% endif %}
      routes:
        - receiver: 'null'
          matchers:
            - alertname =~ "(InfoInhibitor|CephNodeDiskspaceWarning|CephNodeRootFilesystemFull)"
        - receiver: 'watchdog'
          group_interval: 30s
          repeat_interval: 1m
          matchers:
            - alertname = "Watchdog"
        - receiver: 'discord_no_resolved'
          matchers:
            - alertname =~ "^(KubePodOOMKilled)$"
    receivers:
      - name: 'null'
      - name: watchdog
        webhook_configs:
          - url: "{{ vault_alertmanager_watchdog_url }}"
{% if vault_alertmanager_discord_webhook_url is defined %}
      - name: discord
        discord_configs:
          - send_resolved: true
            webhook_url: "{{ vault_alertmanager_discord_webhook_url }}"
            title: '{% raw %}{{ template "discord.andrei.title" . }}{% endraw %}'
            message: '{% raw %}{{ template "discord.andrei.message" . }}{% endraw %}'
      - name: discord_no_resolved
        discord_configs:
          - send_resolved: false
            webhook_url: "{{ vault_alertmanager_discord_webhook_url }}"
            title: '{% raw %}{{ template "discord.andrei.title" . }}{% endraw %}'
            message: '{% raw %}{{ template "discord.andrei.message" . }}{% endraw %}'
{% endif %}
grafana:
  enabled: false
prometheusOperator:
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 128Mi
  prometheusConfigReloader:
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 64Mi
prometheus:
  route:
    main:
      enabled: true
      hostnames:
        - "prom.{{ kube_ingress_domain }}"
      parentRefs:
        - name: envoy
          namespace: envoy-gateway-system

  prometheusSpec:
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    externalLabels: {}
    externalUrl: "http://prom.{{ kube_ingress_domain }}"
    retention: 1y
    storageSpec:
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          storageClassName: rbd-ec
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 300Gi
          dataSourceRef:
            kind: ReplicationDestination
            apiGroup: volsync.backube
            name: prometheus
    resources:
      requests:
        cpu: 300m
        memory: 3Gi
      limits:
        memory: 4Gi
# https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-node-exporter/values.yaml
prometheus-node-exporter:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      memory: 64Mi
  extraArgs:
    - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
    - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$
# permission denied
{% if 'talos' not in group_names %}
    - --collector.systemd
  extraHostVolumeMounts:
    - name: systemd
      hostPath: /run/dbus/system_bus_socket
      mountPath: /var/run/dbus/system_bus_socket
      readOnly: true
      mountPropagation: None
{% endif %}
{% if 'talos' in group_names %}
kubeControllerManager:
  service:
    selector:
      k8s-app: kube-controller-manager

kubeScheduler:
  service:
    selector:
      k8s-app: kube-scheduler
{% endif %}

kubeProxy:
  enabled: {{ kube_proxy_enabled }}

defaultRules:
  disabled:
    KubePdbNotEnoughHealthyPods: true
  rules:
    kubeProxy: {{ kube_proxy_enabled }}

# https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-state-metrics/values.yaml
kube-state-metrics:
  resources:
    requests:
      cpu: 10m
      memory: 128Mi
    limits:
      memory: 128Mi
